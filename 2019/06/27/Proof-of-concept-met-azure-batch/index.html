<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-130626812-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Proof of concept met Azure Batch | Cloud Republic Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Case omschrijving Net als in mijn vorige blog post heb ik een Proof of Concept gemaakt om grote hoeveelheden XML bestanden te transformeren, het gaat dan 3000 bestanden per keer met een totale grote v">
<meta name="keywords" content="Azure, Development, Office365, DevOps, Cloud, Front-end">
<meta property="og:type" content="article">
<meta property="og:title" content="Proof of concept met Azure Batch">
<meta property="og:url" content="https:&#x2F;&#x2F;cloudrepublic.github.io&#x2F;2019&#x2F;06&#x2F;27&#x2F;Proof-of-concept-met-azure-batch&#x2F;index.html">
<meta property="og:site_name" content="Cloud Republic Blog">
<meta property="og:description" content="Case omschrijving Net als in mijn vorige blog post heb ik een Proof of Concept gemaakt om grote hoeveelheden XML bestanden te transformeren, het gaat dan 3000 bestanden per keer met een totale grote v">
<meta property="og:locale" content="EN">
<meta property="og:image" content="https:&#x2F;&#x2F;cloudrepublic.github.io&#x2F;images&#x2F;azure-batch-overview.png">
<meta property="og:updated_time" content="2019-06-28T07:00:31.661Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;cloudrepublic.github.io&#x2F;images&#x2F;azure-batch-overview.png">
  
    <link rel="alternate" href="/atom.xml" title="Cloud Republic Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cloud Republic Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">De Cloud Developers van morgen.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cloudrepublic.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Proof-of-concept-met-azure-batch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/27/Proof-of-concept-met-azure-batch/" class="article-date">
  <time datetime="2019-06-27T17:54:37.000Z" itemprop="datePublished">2019-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Proof of concept met Azure Batch
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Case-omschrijving"><a href="#Case-omschrijving" class="headerlink" title="Case omschrijving "></a>Case omschrijving </h2><p>Net als in mijn vorige <a href="https://cloudrepublic.github.io/2019/03/28/Proof-of-concept-met-durable-functions/">blog post</a> heb ik een Proof of Concept gemaakt om grote hoeveelheden XML bestanden te transformeren, het gaat dan 3000 bestanden per keer met een totale grote van 18 gigabyte. Voor dit artikel kan ik wegens privacy redenen niet de echte data gebruiken en heb ik een dataset gebruikt van <a href="https://www.kaggle.com/datasets" target="_blank" rel="noopener">https://www.kaggle.com/datasets</a>. Het gaat hier om een dataset van landen en de wijnen.</p>
<p>Het doel is om de wijnen uit de XML dump te halen en deze om te zetten naar een JSON formaat en deze bestanden te uploaden in een blob container. We krijgen dus per wijn een JSON bestand in een blob container. Dit alles moet gebeuren op basis Azure Batch met een Azure Function als orchestrator.</p>
<h2 id="Wat-is-de-opzet-van-de-POC"><a href="#Wat-is-de-opzet-van-de-POC" class="headerlink" title="Wat is de opzet van de POC"></a>Wat is de opzet van de POC</h2><p>We gaan de XML bestanden transformeren doormiddel van een Azure Batch component en we starten en beheren de Azure Batch doormiddel van een Azure Function.<br>De Azure Function zal de XML bestanden toevoegen aan een Job in Azure Batch doormiddel van een <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-event-grid" target="_blank" rel="noopener">event grid trigger</a> en via een httptrigger is de voortgang te zien van het batch proces. </p>
<p><img src="/images/azure-batch-overview.png"></p>
<h2 id="Wat-is-Azure-Batch"><a href="#Wat-is-Azure-Batch" class="headerlink" title="Wat is Azure Batch"></a>Wat is Azure Batch</h2><p>Azure Batch is plat gezegd eigenlijk een beheer tool voor virtuele machines. Elk van deze machines kan een taak oppakken en dit als input gebruiken voor een commandline applicatie en het resultaat uploaden in bijvoorbeeld een blob container. </p>
<p>Voor de complete omschrijving wat je met Azure Batch kunt doen verwijs ik je graag door naar de Microsoft site <a href="https://azure.microsoft.com/nl-nl/services/batch/" target="_blank" rel="noopener">https://azure.microsoft.com/nl-nl/services/batch/</a></p>
<h2 id="Hoe-werkt-het-Proof-of-Concept"><a href="#Hoe-werkt-het-Proof-of-Concept" class="headerlink" title="Hoe werkt het Proof of Concept"></a>Hoe werkt het Proof of Concept</h2><p>Azure Batch bestaat uit een aantal componenten.</p>
<ul>
<li>Een Task is een opdracht welke uitgevoerd dient te worden op een node. </li>
<li>Een Job is een verzameling van tasks. Aan een Job hangt ook een Pool.</li>
<li>Een Pool is een verzameling van nodes.</li>
<li>Een Node is een virtuele machine welke een van de tasks gaat uitvoeren. </li>
</ul>
<p>Ik heb 40 bestanden met landen en wijnen. 1 bestand is ongeveer 75 mb groot. Voor testdoeleinden zijn dit dezelfde bestanden met een andere naam. Dit is meer om een gelijkwaardige load op de functie te krijgen als bij de echte POC.</p>
<p>Ik heb een Azure Function welke een event grid trigger heeft welke afgaat op het moment dat er een bestand wordt geupload in de blobcontainer.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"BatchOrchestrator"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">   [EventGridTrigger] EventGridEvent eventGridEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">   ExecutionContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">   ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;StorageBlobCreatedEventData&gt;(eventGridEvent.Data.ToString());</span><br><span class="line">   <span class="keyword">string</span> name = data.Url.Split(<span class="string">'/'</span>).Last();</span><br><span class="line"></span><br><span class="line">   log.LogInformation(<span class="string">$"C# Blob trigger function Processed blob\n Name:<span class="subst">&#123;name&#125;</span>"</span>);</span><br><span class="line">   <span class="keyword">await</span> RunBatch(log, context, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>De bestandsnaam wordt uit de URL gehaald en doorgestuurd naar de methode RunBatch.<br>De methode RunBatch initialiseert een BatchClient met de credentials welke opgegeven zij in de config.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">    BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">    <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Hierna gaan we kijken of er al een job bestaat in het Azure Batch Account. Als er al een job bestaat en hij is nog actief of wordt aangemaakt voegen we hier een task aan toe. Als er geen job actief is of wordt opgestart dan maken we een Job aan. Dit gebeurt in de <em>CreateJob</em> methode.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">    BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">    <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> jobId = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            batchClient.CustomBehaviors.Add(RetryPolicyProvider.ExponentialRetryProvider(TimeSpan.FromSeconds(<span class="number">5</span>), <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (batchClient.JobOperations.ListJobs().Any())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                CloudJob activeJob = jobs.FirstOrDefault(job =&gt; job.State == JobState.Active || job.State == JobState.Enabling);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (activeJob != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.LogDebug(<span class="string">"Job still active"</span>);</span><br><span class="line">                    CreateTaskIfNotExists(batchClient, activeJob.Id, name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            log.LogError(e, e.Message);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(jobId))</span><br><span class="line">            &#123;</span><br><span class="line">                log.LogDebug(<span class="string">$"Deleting job: <span class="subst">&#123;jobId&#125;</span>"</span>);</span><br><span class="line">                <span class="keyword">await</span> batchClient.JobOperations.DeleteJobAsync(jobId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Een Job heeft een pool met nodes nodig welke het werk uitvoeren. We gaan deze dus eerst aanmaken.</p>
<ul>
<li>We specificeren het besturingssysteem in dit geval staat de waarde <em>5</em> voor <em>Windows Server 2016</em> voor de overige waardes check de Azure Guest OS Releases <a href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-guestos-update-matrix#releases" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-guestos-update-matrix#releases</a></li>
<li>We specificeren een virtuele machine size in dit geval een <em>standard_d1_v2</em> voor de overige ondersteunde machines check <a href="https://docs.microsoft.com/en-us/azure/batch/batch-pool-vm-sizes#supported-vm-families-and-sizes" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-pool-vm-sizes#supported-vm-families-and-sizes</a></li>
<li>We specificeren hoeveel tasks er per node gedraaid mogen worden in dit geval 4. Er zullen dus 4 tasks per keer op de node worden gestart.</li>
<li>We specificeren welke applicatie er op de node gedraaid dient te worden. Dit moet een applicatie of script zijn welke via de commandline te draaien is. Deze applicatie kan als een zip bestand worden gupload in de portal. </li>
<li>We zetten de lifetime op <em>PoolLifetimeOption.Job</em> dit wil zeggen zodra alle tasks in de Job klaar zijn zal de pool verwijdert worden en zul je dus ook niet meer betalen voor de virtuele machines. </li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PoolInformation <span class="title">CreatePool</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PoolInformation()</span><br><span class="line">    &#123;</span><br><span class="line">        AutoPoolSpecification = <span class="keyword">new</span> AutoPoolSpecification()</span><br><span class="line">        &#123;</span><br><span class="line">            AutoPoolIdPrefix = <span class="string">"Wine"</span>,</span><br><span class="line">            PoolSpecification = <span class="keyword">new</span> PoolSpecification()</span><br><span class="line">            &#123;</span><br><span class="line">                CloudServiceConfiguration = <span class="keyword">new</span> CloudServiceConfiguration(<span class="string">"5"</span>),</span><br><span class="line">                VirtualMachineSize = <span class="string">"standard_d1_v2"</span>,</span><br><span class="line">                MaxTasksPerComputeNode = <span class="number">4</span>,</span><br><span class="line">                ApplicationPackageReferences = <span class="keyword">new</span> List&lt;ApplicationPackageReference&gt;()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> ApplicationPackageReference()</span><br><span class="line">                    &#123;</span><br><span class="line">                        ApplicationId = <span class="string">"converter"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            KeepAlive = <span class="literal">false</span>,</span><br><span class="line">            PoolLifetimeOption = PoolLifetimeOption.Job</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nu we een Pool hebben kunnen we deze koppelen aan de Job. De <em>CreateJob</em> methode maakt een unieke naam aan voor de job doormiddel van een timestamp te prefixen met “WineConverter”.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">string</span>&gt; <span class="title">CreateJob</span>(<span class="params"><span class="keyword">string</span> name, BatchClient batchClient</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> jobId;</span><br><span class="line"></span><br><span class="line">    CloudJob activeJob;</span><br><span class="line">    jobId = CreateJobId(<span class="string">"WineConverter"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create pool</span></span><br><span class="line">    PoolInformation pool = CreatePool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a job</span></span><br><span class="line">    activeJob = <span class="keyword">await</span> CreateJobAsync(batchClient, jobId, pool);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create tasks from the blobs</span></span><br><span class="line">    CreateTaskIfNotExists(batchClient, jobId, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> activeJob.RefreshAsync();</span><br><span class="line">    activeJob.OnAllTasksComplete = OnAllTasksComplete.TerminateJob;</span><br><span class="line">    <span class="keyword">await</span> activeJob.CommitChangesAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jobId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We controlleren eerst of de task al is aangemaakt en is toegevoegd aan de job, zoniet dan voegen we hem toe. De naam van de task mag alleen letters en cijfers bevatten en een koppelteken en underscore.</p>
<p>Ook stellen we in welke package de task moet starten met welke argumenten. Hier starten we converter.exe met als argument een naam van de blob (in dit geval een XML bestand met wijn data).</p>
<p>De converter.exe bevat alle logica om de xml te verwerken en het resultaat te uploaden in een Azure blob container.<br>In de Azure portal kan je een package uploaden welke op de nodes geinstalleerd moeten worden. Meer informatie over hoe packages werken met Azure batch is te vinden op: <a href="https://docs.microsoft.com/en-us/azure/batch/batch-application-packages" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-application-packages</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateTaskIfNotExists</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, <span class="keyword">string</span> blobName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IPagedEnumerable&lt;CloudTask&gt; tasks = batchClient.JobOperations.ListTasks(jobId);</span><br><span class="line">    <span class="keyword">string</span> taskId = <span class="string">$"task_<span class="subst">&#123;SanitizeString(blobName)&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tasks.Any(x =&gt; x.Id == taskId))</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$"Task with id: <span class="subst">&#123;taskId&#125;</span> all ready exists"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    batchClient.JobOperations.AddTask(jobId, <span class="keyword">new</span> CloudTask(taskId, <span class="string">$"cmd /c %AZ_BATCH_APP_PACKAGE_CONVERTER%\\converter.exe -name <span class="subst">&#123;blobName&#125;</span>"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="De-volledige-code"><a href="#De-volledige-code" class="headerlink" title="De volledige code"></a>De volledige code</h2><p>Zie hieronder de volledige code. Er is een extra function aan toegevoegd met een httptrigger zodra je deze aanroept worden alle jobs met de bijhorende tasks weergegeven en de status van de tasks. Het endpoint is nu niet beveiligd maar dit is omdat het een demo is.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch.Auth;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch.Common;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.WebJobs;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.WebJobs.Extensions.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> JobState = Microsoft.Azure.Batch.Common.JobState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WineConverter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BatchOrchestrator</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">FunctionName(<span class="meta-string">"BatchOrchestrator"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">           [EventGridTrigger] EventGridEvent eventGridEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">           ExecutionContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">           ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">           <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;StorageBlobCreatedEventData&gt;(eventGridEvent.Data.ToString());</span><br><span class="line">           <span class="keyword">string</span> name = data.Url.Split(<span class="string">'/'</span>).Last();</span><br><span class="line"></span><br><span class="line">           log.LogInformation(<span class="string">$"C# Blob trigger function Processed blob\n Name:<span class="subst">&#123;name&#125;</span>"</span>);</span><br><span class="line">           <span class="keyword">await</span> RunBatch(log, context, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">            BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">            <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> jobId = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    batchClient.CustomBehaviors.Add(RetryPolicyProvider.ExponentialRetryProvider(TimeSpan.FromSeconds(<span class="number">5</span>), <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (batchClient.JobOperations.ListJobs().Any())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                        CloudJob activeJob = jobs.FirstOrDefault(job =&gt; job.State == JobState.Active || job.State == JobState.Enabling);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (activeJob != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            log.LogDebug(<span class="string">"Job still active"</span>);</span><br><span class="line">                            CreateTaskIfNotExists(batchClient, activeJob.Id, name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.LogError(e, e.Message);</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(jobId))</span><br><span class="line">                    &#123;</span><br><span class="line">                        log.LogDebug(<span class="string">$"Deleting job: <span class="subst">&#123;jobId&#125;</span>"</span>);</span><br><span class="line">                        <span class="keyword">await</span> batchClient.JobOperations.DeleteJobAsync(jobId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">FunctionName(<span class="meta-string">"BatchStatus"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">BatchStatus</span>(<span class="params">[HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">"get"</span></span>)]HttpRequestMessage req, ExecutionContext context, ILogger log)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            List&lt;Job&gt; jobList = <span class="keyword">new</span> List&lt;Job&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line">            BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">            <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">            &#123;</span><br><span class="line">                IPagedEnumerable&lt;CloudJob&gt; jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                <span class="keyword">if</span> (jobs.Any())</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (CloudJob cloudJob <span class="keyword">in</span> jobs.ToList())</span><br><span class="line">                    &#123;</span><br><span class="line">                        jobList.Add(<span class="keyword">new</span> Job()</span><br><span class="line">                        &#123;</span><br><span class="line">                            Id = cloudJob.Id,</span><br><span class="line">                            Name = cloudJob.DisplayName,</span><br><span class="line">                            Status = cloudJob.State.ToString(),</span><br><span class="line">                            Tasks = cloudJob.ListTasks().Select(task =&gt; <span class="keyword">new</span> JobTask()</span><br><span class="line">                            &#123;</span><br><span class="line">                               Id = task.Id,</span><br><span class="line">                               Name = task.DisplayName,</span><br><span class="line">                               Status = task.State.ToString()</span><br><span class="line">                            &#125;).ToList()</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> JsonConvert.SerializeObject(jobList, Formatting.Indented);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">string</span>&gt; <span class="title">CreateJob</span>(<span class="params"><span class="keyword">string</span> name, BatchClient batchClient</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> jobId;</span><br><span class="line"></span><br><span class="line">            CloudJob activeJob;</span><br><span class="line">            jobId = CreateJobId(<span class="string">"WineConverter"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create pool</span></span><br><span class="line">            PoolInformation pool = CreatePool();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// create a job</span></span><br><span class="line">            activeJob = <span class="keyword">await</span> CreateJobAsync(batchClient, jobId, pool);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create tasks from the blobs</span></span><br><span class="line">            CreateTaskIfNotExists(batchClient, jobId, name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> activeJob.RefreshAsync();</span><br><span class="line">            activeJob.OnAllTasksComplete = OnAllTasksComplete.TerminateJob;</span><br><span class="line">            <span class="keyword">await</span> activeJob.CommitChangesAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> jobId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PoolInformation <span class="title">CreatePool</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PoolInformation()</span><br><span class="line">            &#123;</span><br><span class="line">                AutoPoolSpecification = <span class="keyword">new</span> AutoPoolSpecification()</span><br><span class="line">                &#123;</span><br><span class="line">                    AutoPoolIdPrefix = <span class="string">"Wine"</span>,</span><br><span class="line">                    PoolSpecification = <span class="keyword">new</span> PoolSpecification()</span><br><span class="line">                    &#123;</span><br><span class="line">                        CloudServiceConfiguration = <span class="keyword">new</span> CloudServiceConfiguration(<span class="string">"5"</span>),</span><br><span class="line">                        VirtualMachineSize = <span class="string">"standard_d1_v2"</span>,</span><br><span class="line">                        MaxTasksPerComputeNode = <span class="number">4</span>,</span><br><span class="line">                        ApplicationPackageReferences = <span class="keyword">new</span> List&lt;ApplicationPackageReference&gt;()</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">new</span> ApplicationPackageReference()</span><br><span class="line">                            &#123;</span><br><span class="line">                                ApplicationId = <span class="string">"converter"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    KeepAlive = <span class="literal">false</span>,</span><br><span class="line">                    PoolLifetimeOption = PoolLifetimeOption.Job</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;CloudJob&gt; <span class="title">CreateJobAsync</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, PoolInformation pool</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CloudJob unboundJob = batchClient.JobOperations.CreateJob();</span><br><span class="line">            unboundJob.Id = jobId;</span><br><span class="line"></span><br><span class="line">            unboundJob.PoolInformation = pool;</span><br><span class="line">            <span class="keyword">await</span> unboundJob.CommitAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> unboundJob;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateTaskIfNotExists</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, <span class="keyword">string</span> blobName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IPagedEnumerable&lt;CloudTask&gt; tasks = batchClient.JobOperations.ListTasks(jobId);</span><br><span class="line">            <span class="keyword">string</span> taskId = <span class="string">$"task_<span class="subst">&#123;SanitizeString(blobName)&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tasks.Any(x =&gt; x.Id == taskId))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$"Task with id: <span class="subst">&#123;taskId&#125;</span> all ready exists"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            batchClient.JobOperations.AddTask(jobId, <span class="keyword">new</span> CloudTask(taskId, <span class="string">$"cmd /c %AZ_BATCH_APP_PACKAGE_CONVERTER%\\converter.exe -name <span class="subst">&#123;blobName&#125;</span>"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">CreateJobId</span>(<span class="params"><span class="keyword">string</span> prefix</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$"<span class="subst">&#123;prefix&#125;</span>-<span class="subst">&#123;DateTime.Now:yyyyMMdd-HHmmss&#125;</span>"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">SanitizeString</span>(<span class="params"><span class="keyword">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> pattern = <span class="string">@"[^A-Za-z0-9-_]"</span>;</span><br><span class="line">            <span class="keyword">return</span> System.Text.RegularExpressions.Regex.Replace(text, pattern, <span class="keyword">string</span>.Empty);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IConfigurationRoot <span class="title">ReadSettings</span>(<span class="params">ExecutionContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">                .SetBasePath(context.FunctionAppDirectory)</span><br><span class="line">                .AddJsonFile(<span class="string">"local.settings.json"</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>)</span><br><span class="line">                .AddEnvironmentVariables()</span><br><span class="line">                .Build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobTask</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Status &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Job</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Status &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;JobTask&gt; Tasks &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conclusie"><a href="#Conclusie" class="headerlink" title="Conclusie"></a>Conclusie</h2><p>Azure batch is echt een serieuze keuze als je grote hoeveelheden data moet verwerken en je wilt in controle zijn wat er allemaal gebeurt.<br>Je kan zowel horizontaal als verticaal schalen en het aantal nodes wat het werk kan doen is standaard 20 maar je kunt een request doen voor meer nodes. Voor de recource limieten check de documentatie <a href="https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit</a>.</p>
<p>Ik ken zelf weinig projecten waar ze Azure batch gebruiken maar ik ben echt onder de indruk hoe simpel en krachtig Azure batch is plus je betaald alleen voor de tijd dat de nodes ook echt iets doen dus geen vaste maandelijkse kosten.</p>
<p>Deze POC heeft het qua performance zijn doel wel behaald wat we voor ogen hadden alleen het bevat toch net te veel stappen om het volledig via CI/CD gemakkelijk te deployen. </p>
<p>In een volgende blog zal ik de uiteindelijke oplossing uitwerken met verschillende functie apps op een consumption plan welke aan alle eisen voldoet.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/06/27/Proof-of-concept-met-azure-batch/" data-id="cjxfqz4xm0000xgunr03325se" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/10/17/CICD-SharePointFramework-part-1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Continuous Integration &amp; Deployment with SharePoint Framework Solutions - Part 1 of 2
        
      </div>
    </a>
  
  
    <a href="/2019/06/14/Getting-started-with-SPfx/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Getting started with SharePoint Framework</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AngularJS/" rel="tag">AngularJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Certificering/" rel="tag">Certificering</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Republic/" rel="tag">Cloud Republic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuous-Deployment/" rel="tag">Continuous Deployment</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuous-Integration/" rel="tag">Continuous Integration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker-swarm/" rel="tag">Docker swarm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Frontend/" rel="tag">Frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gulp/" rel="tag">Gulp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hybrid/" rel="tag">Hybrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Let-s-Encrypt/" rel="tag">Let's Encrypt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Build/" rel="tag">Microsoft Build</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Office-365/" rel="tag">Office 365</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Portainer/" rel="tag">Portainer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Release-pipeline/" rel="tag">Release pipeline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Release-schedule/" rel="tag">Release schedule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPFx/" rel="tag">SPFx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SharePoint-Framework/" rel="tag">SharePoint Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SharePoint-Online/" rel="tag">SharePoint Online</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Traefik/" rel="tag">Traefik</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpart/" rel="tag">Webpart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Workbench/" rel="tag">Workbench</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Angular/" style="font-size: 10px;">Angular</a> <a href="/tags/AngularJS/" style="font-size: 10px;">AngularJS</a> <a href="/tags/Azure/" style="font-size: 10px;">Azure</a> <a href="/tags/Azure-DevOps/" style="font-size: 10px;">Azure DevOps</a> <a href="/tags/Certificering/" style="font-size: 10px;">Certificering</a> <a href="/tags/Cloud-Republic/" style="font-size: 10px;">Cloud Republic</a> <a href="/tags/Continuous-Deployment/" style="font-size: 10px;">Continuous Deployment</a> <a href="/tags/Continuous-Integration/" style="font-size: 10px;">Continuous Integration</a> <a href="/tags/Docker-swarm/" style="font-size: 10px;">Docker swarm</a> <a href="/tags/Frontend/" style="font-size: 20px;">Frontend</a> <a href="/tags/Gulp/" style="font-size: 10px;">Gulp</a> <a href="/tags/Hybrid/" style="font-size: 10px;">Hybrid</a> <a href="/tags/Let-s-Encrypt/" style="font-size: 10px;">Let's Encrypt</a> <a href="/tags/Microsoft-Build/" style="font-size: 10px;">Microsoft Build</a> <a href="/tags/Office-365/" style="font-size: 20px;">Office 365</a> <a href="/tags/Portainer/" style="font-size: 10px;">Portainer</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Release-pipeline/" style="font-size: 10px;">Release pipeline</a> <a href="/tags/Release-schedule/" style="font-size: 10px;">Release schedule</a> <a href="/tags/SPFx/" style="font-size: 20px;">SPFx</a> <a href="/tags/SharePoint-Framework/" style="font-size: 20px;">SharePoint Framework</a> <a href="/tags/SharePoint-Online/" style="font-size: 20px;">SharePoint Online</a> <a href="/tags/Traefik/" style="font-size: 10px;">Traefik</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Webpart/" style="font-size: 20px;">Webpart</a> <a href="/tags/Workbench/" style="font-size: 10px;">Workbench</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/03/Docker-Swarm/">Docker Swarm, Traefik, Let&#39;s Encrypt en Portainer</a>
          </li>
        
          <li>
            <a href="/2019/10/17/CICD-SharePointFramework-part-1/">Continuous Integration &amp; Deployment with SharePoint Framework Solutions - Part 1 of 2</a>
          </li>
        
          <li>
            <a href="/2019/06/27/Proof-of-concept-met-azure-batch/">Proof of concept met Azure Batch</a>
          </li>
        
          <li>
            <a href="/2019/06/14/Getting-started-with-SPfx/">Getting started with SharePoint Framework</a>
          </li>
        
          <li>
            <a href="/2019/05/22/follow-the-moon/">Following the moon</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Cloud Republic<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>