<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-130626812-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Cloud Republic Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="Azure, Development, Office365, DevOps, Cloud, Front-end">
<meta property="og:type" content="website">
<meta property="og:title" content="Cloud Republic Blog">
<meta property="og:url" content="https:&#x2F;&#x2F;cloudrepublic.github.io&#x2F;index.html">
<meta property="og:site_name" content="Cloud Republic Blog">
<meta property="og:locale" content="EN">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Cloud Republic Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cloud Republic Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">De Cloud Developers van morgen.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cloudrepublic.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Docker-Swarm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/03/Docker-Swarm/" class="article-date">
  <time datetime="2019-11-03T11:00:00.000Z" itemprop="datePublished">2019-11-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/03/Docker-Swarm/">Docker Swarm, Traefik, Let&#39;s Encrypt en Portainer</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Case-omschrijving"><a href="#Case-omschrijving" class="headerlink" title="Case omschrijving "></a>Case omschrijving </h2><p>Niet lang geleden heb ik besloten om mij eens goed te gaan verdiepen in Docker. Je hoort het overal en het wordt steeds populairder en ik hoor steeds vaker dat het een goed alternatief is voor de huidige manier van werken namelijk Faas en Paas in een public cloud hierdoor ben ik nieuwsgierig geworden en wil ik eens kijken wat hier nu de voordelen van zijn. Ik ben begonnen om mij te certificeren, ik heb een cursus gevolgd en mijn examen met succes behaald. Ik vind het altijd belangrijk om te weten hoe iets in elkaar zit en waarom het zo in elkaar zit. Mijn idee is om een of meerdere productie applicaties op een Docker Swarm cluster te gaan draaien. In deze blog ga ik laten zien hoe ik een goede infrastructuur bouw om de applicaties te hosten.</p>
<p>De omgeving moest aan de volgende voorwaarden voldoen:</p>
<ul>
<li>Er moeten meerdere web applicaties op kunnen draaien welke op poort 80 en 443 benaderd kunnen worden.</li>
<li>Alle web applicaties moeten draaien op SSL, dit moet mij zo min mogelijk werk kosten.</li>
<li>De oplossing moet schaalbaar zijn en bestand zijn tegen het uitvallen en/of offline gaan van servers.</li>
<li>Ik wil de oplossing kunnen hosten bij een Cloud provider, Hosting provider of lokaal om te kunnen testen.</li>
<li>Het beheren van de containers moet gemakkelijk en overzichtelijk zijn.</li>
<li>Aangezien ik een echte Hollander ben moeten de kosten ook een beetje beperkt blijven.</li>
</ul>
<p>De oplossing welke ik heb gemaakt is een combinatie van Docker Swarm, Traefik, Let’s Encrypt en Portainer.</p>
<h2 id="Wat-is-Docker-Swarm"><a href="#Wat-is-Docker-Swarm" class="headerlink" title="Wat is Docker Swarm"></a>Wat is Docker Swarm</h2><p>Docker Swarm is een tool waarmee je Docker-containers kunt beheren en schalen. Als je Docker installeert dan krijg je daar meteen Swarm bij. Docker Swarm is een standaard product van Docker wat bij elke installatie van Docker wordt meegeleverd. Met Docker Swarm kun je een cluster bouwen van verschillende virtuele machines deze worden hierna nodes genoemd. Hierop kunnen de Docker-containers worden gedeployed als een stack[^2] of een service[^1]. Als je een cluster wilt hebben wat een hoge beschikbaarheid heeft wordt aangeraden om minstens 3 manager nodes te hebben. Docker Swarm maakt namelijk gebruik van het Raft Consensus Algoritme, 1 manager is de leider van de swarm en de status van de manager wordt gesynchroniseerd over de overige managers. Mocht de leider niet meer beschikbaar zijn om wat voor reden dan ook kan een andere manager zijn taken over nemen.</p>
<p>Om te berekenen hoeveel managers er mogen uitvallen voordat het cluster niet meer kan functioneren wordt de volgende berekening gebruikt:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X = (N-1)/2</span><br></pre></td></tr></table></figure></p>
<p>Bij dus een cluster van 3 manager mag er 1 manager uitvallen en zal het cluster nog steeds functioneren. Docker adviseert om niet meer dan 7 managers te gebruiken om performance issues met het synchroniseren te voorkomen. Voor meer informatie zie <a href="https://docs.docker.com/engine/swarm/raft/" target="_blank" rel="noopener">https://docs.docker.com/engine/swarm/raft/</a></p>
<p>Om een Docker Swarm cluster op te zetten kun je de volgende stappen uitvoeren:</p>
<ul>
<li>Installeer 5 virtuele machine met bijv. Ubuntu server. Voor de 3 managers hebben we niet hele zware virtuele machines nodig. Een basic A1 1.75 GB RAM volstaat al voor een manager node. Voor de 2 worker nodes zou ik kiezen voor een virtuele machine met 8 GB RAM. </li>
<li>Installeer Docker community edition op alle 5 de servers. Volg de handleiding op <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a>. </li>
<li>Op 1 van de manager servers voer het volgende commando uit om Docker Swarm te initialiseren.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init --advertise-addr &quot;public ipadres van de server&quot;</span><br><span class="line">Swarm initialized: current node (bvz81updecsj6wjz393c09vti) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join \npm install hexo --save</span><br><span class="line">    --token SWMTKN-1-3pu6hszjas19xyp7ghgosyx9k8atbfcr8p2is99znpy26u2lkl-1awxwuwd3z9j1z3puu7rcgdbx \</span><br><span class="line">    172.17.0.2:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<ul>
<li>Voer het bovenstaande docker swarm join token uit op de 2 nodes. </li>
<li>Voer het commando docker swarm join-token manager uit en voer het join commando uit op de overige 2 managers.</li>
</ul>
<p>Als dit klaar gedaan is heb je een Docker Swarm cluster gemaakt zoals in het onderstaande overzicht is weergegeven.</p>
<p><img src="/images/Docker-Swarm-overview.png"><br>Mocht je meer details willen hebben over het opzetten van een Docker Swarm cluster kijk dan op: <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/" target="_blank" rel="noopener">https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/</a></p>
<p>Docker Swarm zal niet automatisch schalen als de load op je applicatie hoger wordt, wil je meer containers uitrollen van je applicatie kun je dit doen door meer replica’s aan te maken. Als je bijv. de service api_api wilt opschalen naar 5 instanties kun je dit doen door middel van het volgende commando:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service scale api_api=5</span><br></pre></td></tr></table></figure>
<p>Je kunt de schaling ook regelen in de UI van Portainer. Verderop in het artikel ga ik dieper in op hoe en wat Portainer is.<br><img src="/images/Docker-Swarm-scaling.png"></p>
<p>Mocht je nu toch te weinig capaciteit hebben in je cluster kun je eenvoudig een nieuwe virtuele machine inrichten met Ubuntu en Docker erop installeren. Hierna voer je het Docker Swarm join commando uit op de server en deze zal het bestaande cluster uitbreiden met de extra capaciteit. Om inzicht te krijgen in de performance van het cluster zijn monitoring applicaties beschikbaar, een van de bekendere is Prometheus. Het gaat in deze blog te ver om de ins en outs van Prometheus te behandelen. Mocht je meer informatie willen hebben over Prometheus zie <a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join \</span><br><span class="line">    --token SWMTKN-1-3pu6hszjas19xyp7ghgosyx9k8atbfcr8p2is99znpy26u2lkl-1awxwuwd3z9j1z3puu7rcgdbx \</span><br><span class="line">    172.17.0.2:2377</span><br></pre></td></tr></table></figure>
<p>Mocht je Docker Swarm op Azure hebben uitgerold kun je gebruik maken van een vm scale sets om automatisch nodes bij je cluster te zetten. Ik heb hier verder nog geen ervaring mee maar ga hier zeker mee aan de slag.</p>
<p>Omdat ik Docker Swarm gebruik kan ik de volgende punten afvinken van mijn lijstje:</p>
<ul>
<li>De oplossing moet schaalbaar zijn en bestand zijn tegen het uitvallen of offline gaan van servers.<br>  – In het cluster zitten 3 managers dus er kan er 1 offline gaan volgens de berekening: “3 managers - 1 = 2  2/2 = 1.<br>  – Ook hebben we 2 workers welke de containers kunnen hosten. Mocht er 1 offline gaan worden de containers opnieuw gestart op de andere node.<br>  – De manager heeft onder andere als taak om er voor te zorgen dat de containers draaien op 1 of meerdere nodes.</li>
<li>Ik wil de oplossing kunnen hosten bij een Cloud provider, Hosting provider of lokaal om te kunnen testen.<br>  – Omdat Docker Swarm standaard in elke Docker installatie zit kan het zonder verdere installatie van tools gebruikt worden overal waar je Docker hebt geïnstalleerd.  </li>
</ul>
<h2 id="Wat-is-Let’s-Encrypt"><a href="#Wat-is-Let’s-Encrypt" class="headerlink" title="Wat is Let’s Encrypt"></a>Wat is Let’s Encrypt</h2><p>Let’s Encrypt is een certificaatautoriteit opgericht op 16 april 2016. Het geeft X.509 certificaten uit voor het Transport Layer Security (TLS) encryptie-protocol, zonder dat dit kosten met zich meebrengt. De certificaten worden uitgegeven via een geautomatiseerd proces dat is ontworpen om het tot nu toe complexe proces van handmatige validatie, ondertekening, installatie en hernieuwing van certificaten voor beveiligde websites te elimineren. (<a href="https://nl.wikipedia.org/wiki/Let%27s_Encrypt" target="_blank" rel="noopener">Wikipedia</a>)</p>
<p>Voor meer informatie over Let’s Encrypt zie <a href="https://letsencrypt.org/" target="_blank" rel="noopener">https://letsencrypt.org/</a></p>
<h2 id="Wat-is-Traefik"><a href="#Wat-is-Traefik" class="headerlink" title="Wat is Traefik"></a>Wat is Traefik</h2><p>Traefik is een opensource router welke speciaal is ontworpen voor container oplossingen. Traefik wordt als global service op elke manager gedeployed op het cluster. Dit wil zeggen elke node met als rol manager krijgt een Traefik container. De reden dat Traefik op de manager nodes gedeployed dient te worden is dat de Docker api wordt uitgelezen. Zodra er een container bij komt en deze is geconfigureerd met de Traefik labels kan Traefik de labels van de container uitlezen en een virtuele host aanmaken voor de container en een SSL-certificaat aanvragen bij Let’s Encrypt. Zodoende is de container beschikbaar voor de buitenwereld met een SSL-certificaat.</p>
<p>Zie hier een voorbeeld Docker-Compose[^3] file om een Traefik container te deployen als stack[^2] op het Docker Swarm cluster.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.7'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  traefik:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">traefik:1.7.13</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      - target:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        published:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">host</span></span><br><span class="line"><span class="attr">      - target:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">        published:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">host</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      --api</span></span><br><span class="line"><span class="string">      --acme</span></span><br><span class="line"><span class="string">      --acme.storage=/certs/acme.json</span></span><br><span class="line"><span class="string">      --acme.entryPoint=https</span></span><br><span class="line"><span class="string">      --acme.httpChallenge.entryPoint=http</span></span><br><span class="line"><span class="string">      --acme.onHostRule=true</span></span><br><span class="line"><span class="string">      --acme.onDemand=false</span></span><br><span class="line"><span class="string">      --acme.acmelogging=true</span></span><br><span class="line"><span class="string">      --acme.email=$&#123;EMAIL&#125;</span></span><br><span class="line"><span class="string">      --docker</span></span><br><span class="line"><span class="string">      --docker.swarmMode</span></span><br><span class="line"><span class="string">      --docker.domain=$&#123;DOMAIN&#125;</span></span><br><span class="line"><span class="string">      --docker.watch</span></span><br><span class="line"><span class="string">      --defaultentrypoints=http,https</span></span><br><span class="line"><span class="string">      --entrypoints='Name:http Address::80'</span></span><br><span class="line"><span class="string">      --entrypoints='Name:https Address::443 TLS'</span></span><br><span class="line"><span class="string">      --logLevel=DEBUG</span></span><br><span class="line"><span class="string">      --accessLog</span></span><br><span class="line"><span class="string"></span><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="attr">      - traefik_certs:</span><span class="string">/certs</span></span><br><span class="line"><span class="attr">    configs:</span></span><br><span class="line"><span class="attr">      - source:</span> <span class="string">traefik_htpasswd</span></span><br><span class="line"><span class="attr">        target:</span> <span class="string">/etc/htpasswd</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">global</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      placement:</span></span><br><span class="line"><span class="attr">        constraints:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span></span><br><span class="line"><span class="attr">      update_config:</span></span><br><span class="line"><span class="attr">        parallelism:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        delay:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">      restart_policy:</span></span><br><span class="line"><span class="attr">        condition:</span> <span class="string">on-failure</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.docker.network=public"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.port=8080"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.backend=traefik"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.enable=true"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.frontend.rule=Host:traefik.$&#123;DOMAIN&#125;"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.frontend.auth.basic.usersFile=/etc/htpasswd"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.frontend.headers.SSLRedirect=true"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"traefik.frontend.entryPoints=http,https"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configs:</span></span><br><span class="line"><span class="attr">  traefik_htpasswd:</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">./htpasswd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  public:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  traefik_certs:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>Om de stack* uit te rollen voeren we het volgende commando uit om een manager node:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c docker-compose.traefik.yml proxy</span><br></pre></td></tr></table></figure></p>
<p>Een kleine samenvatting wat er gebeurt in dit Docker-Compose[^3] bestand:</p>
<ul>
<li>We maken een container aan op basis van traefik:1.7.13.</li>
<li>We publiseren poort 80 en 443.</li>
<li>We regelen de Docker swarm en acme configuratie in.</li>
<li>We mounten 2 volumes.</li>
<li>We koppelen het wachtwoord bestand vanuit de config.</li>
<li>We zorgen dat het wordt uitgerold op elke manager in het cluster.</li>
<li>We regelen de webui van Traefik in.</li>
<li>We maken een netwerk aan genaamd Public van het type overlay. </li>
</ul>
<p>Voor meer informatie over Traefik zie <a href="https://traefik.io/" target="_blank" rel="noopener">https://traefik.io/</a></p>
<p>Omdat ik Traefik gebruik als reverse proxy kan ik de volgende punten afvinken van mijn lijstje:</p>
<ul>
<li>Er moeten meerdere web applicaties op kunnen draaien welke op poort 80 en 443 benaderd kunnen worden.<br>  – Doordat Traefik de labels van containers kan uitlezen maakt het automatisch virtuele hosts aan.</li>
<li>Alle webapplicaties moeten draaien op ssl, dit moet mij zo min mogelijk werk kosten.<br>  – Traefik ondersteund out of the box Let’s Encrypt SSL-certificaten.</li>
</ul>
<h2 id="Wat-is-Portainer"><a href="#Wat-is-Portainer" class="headerlink" title="Wat is Portainer"></a>Wat is Portainer</h2><p>Portainer is een opensource web interface om je Docker te beheren zowel lokaal als remote. Met Portainer kun je de volgende Docker concepten beheren:  </p>
<ul>
<li>Containers</li>
<li>Images</li>
<li>Networks</li>
<li>Volumes</li>
<li>Services</li>
<li>Swarm Cluster</li>
</ul>
<p><img src="/images/Docker-Swarm-portainer-dashboard.png"></p>
<p>Portainer dient ook op een manager node geïnstalleerd te worden omdat Portainer ook via de Docker api het cluster beheerd. Tevens is er Portainer agent beschikbaar welke als global service gedeployed dient te worden op alle nodes zodat Portainer ook weet heeft welke containers op welke nodes draaien.</p>
<p>Zie hier een voorbeeld Docker-Compose[^3] file om een Portainer container en een Portainer agent te deployen als stack** op Docker Swarm.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  agent:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">portainer/agent</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      AGENT_CLUSTER_ADDR:</span> <span class="string">tasks.agent</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/lib/docker/volumes:/var/lib/docker/volumes</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">private</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">global</span></span><br><span class="line"><span class="attr">  portainer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">portainer/portainer</span></span><br><span class="line"><span class="attr">    command:</span> <span class="bullet">-H</span> <span class="attr">tcp://tasks.agent:9001</span> <span class="bullet">--tlsskipverify</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - portainer-data:</span><span class="string">/data</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">private</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      placement:</span></span><br><span class="line"><span class="attr">        constraints:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.frontend.rule=Host:portainer.$&#123;DOMAIN&#125;</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.enable=true</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.port=9000</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.tags=public</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.docker.network=public</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.redirectorservice.frontend.entryPoints=http</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.redirectorservice.frontend.redirect.entryPoint=https</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.webservice.frontend.entryPoints=https</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  private:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">private</span></span><br><span class="line"><span class="attr">  public:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  portainer-data:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>Om de stack** uit te rollen voeren we het volgende commando uit om een manager node:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c docker-compose.portainer.yml portainer</span><br></pre></td></tr></table></figure></p>
<p>Vanaf nu kunnen we Portainer benaderen op de URL <a href="https://portainer.yourdomain.com" target="_blank" rel="noopener">https://portainer.yourdomain.com</a> en kunnen we hier vandaan de rest van de services[^1] en stacks* deployen en beheren.</p>
<p>Een kleine samenvatting wat er gebeurt in dit Docker-Compose[^3] bestand:</p>
<ul>
<li>We maken een container aan op basis van portainer/portainer en portainer/agent.</li>
<li>We publiceren poort 9000 voor de UI.</li>
<li>We regelen de Traefik configuratie in.</li>
<li>We mounten een volume voor de Portainer data.</li>
<li>We zorgen dat de Portainer container wordt uitgerold op een manager in het cluster en dat de agent op elke node in het cluster wordt uitgerold. </li>
<li>We maken een netwerk aan met de naam Private en koppelen dit aan de agent en de Portainer UI.</li>
<li>We koppelen de Portainer UI ook aan het netwerk Public wat we hebben aangemaakt in de Traefik deploy.</li>
</ul>
<p>Voor meer informatie over Portainer kijk op: <a href="https://www.portainer.io/" target="_blank" rel="noopener">https://www.portainer.io/</a>. </p>
<p>Omdat ik Portainer gebruik als beheer tool kan ik het laatste punt afvinken van mijn lijstje:</p>
<ul>
<li>Het beheren van de containers moet gemakkelijk en overzichtelijk zijn. </li>
</ul>
<h2 id="De-combinatie-van-Docker-Swarm-Traefik-Let’s-Encrypt-en-Portainer"><a href="#De-combinatie-van-Docker-Swarm-Traefik-Let’s-Encrypt-en-Portainer" class="headerlink" title="De combinatie van Docker Swarm, Traefik, Let’s Encrypt en Portainer"></a>De combinatie van Docker Swarm, Traefik, Let’s Encrypt en Portainer</h2><p>We hebben het hierboven gehad over Docker Swarm, Traefik, Let’s Encrypt en Portainer maar hoe ziet dat landschap er nu uit.<br>In de volgende afbeelding heb ik een overzicht van het landschap zoals hierboven omschreven.</p>
<p><img src="/images/Docker-Swarm-landschap.png"></p>
<p>Ik heb gekozen om Azure Traffic Manager te gebruiken als loadbalancer voor om het verkeer te verdelen tussen de 3 verschillende managers. De gedachte hier achter is grotendeels dat het een erg goedkope service is in Azure en het werkt ook met externe endpoints. Je bent dus niet verplicht om je virtuele machines op Azure te moeten draaien dit geeft je weer de flexibiliteit om de machines overal te hosten.</p>
<p>Ik heb 3 endpoints gedefineerd in de Azure Traffic Manager 1 endpoint voor elke manager.<br>Ik heb Azure Traffic Manager ingeregeld dat hij voor de beste performance kiest. Je kunt een protocol, poort en eventueel een pad opgeven wat hij moet controleren. Mocht het endpoint niet meer beschikbaar zijn zal er geen verkeer meer naar toe gestuurd worden. Dus als er een storing of een update is van een manager zal er geen downtime zijn in de applicaties. Als er een manager niet bereikbaar is hebben we nog 2 andere managers over welke het werk overnemen.</p>
<p><img src="/images/Docker-Swarm-traffic-manager-configuration.png"></p>
<p>Hierna komt het verkeer binnen op de Traefik loadbalancer welke de Reverse proxy en de SSL-certificaten verzorgd. Traefik weet welk request er naar welke container gestuurd moet worden door middel van de labels welke zijn ingesteld bij het deployen van de stack[^2] of service[^1] en Docker maakt intern gebruikt van zijn eigen DNS server zodat er bekend is welke container er op welke node draait. </p>
<p>Zie hier een voorbeeld Docker-Compose[^3] file met labels om een Docker container met een webapplicatie te deployen als stack** op een Docker Swarm cluster.<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">  version:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  web:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">marcoippel/web:0.1</span></span><br><span class="line"><span class="attr">    environment:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">ASPNETCORE_URLS=http://+:5000</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      placement:</span></span><br><span class="line"><span class="attr">        constraints:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">node.role</span> <span class="string">==</span> <span class="string">worker</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.frontend.rule=Host:test.$&#123;DOMAIN&#125;</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.enable=true</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.port=80</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.tags=public</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.docker.network=public</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.redirectorservice.frontend.entryPoints=http</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.redirectorservice.frontend.redirect.entryPoint=https</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">traefik.webservice.frontend.entryPoints=https</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  public:</span></span><br><span class="line"><span class="attr">    external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p>Het Docker-Compose[^3] bestand kan in Portainer als stack gedeployed worden op het cluster.</p>
<h2 id="Conclusie"><a href="#Conclusie" class="headerlink" title="Conclusie"></a>Conclusie</h2><p>Ik vind dat de combinatie van de verschillende tools een goede basis is voor het applicatielandschap. Het is flexibel, schaalbaar en niet bijzonder complex. Docker Swarm staat ook bekend om zijn eenvoudigheid. Aangezien ik geen infrastructuur met honderden nodes en duizenden containers hoef te hosten is dit een hele geschikte oplossing. Docker Swarm heeft niet een hele steile leercurve dus je kunt er al snel mee aan de slag. Door de reverse proxy van Traefik kunnen virtuele hosts automatisch worden aangemaakt en is SSL meteen geregeld. Met Portainer als UI voor het beheer kun je in een mum van tijd een heel applicatie landschap optuigen zonder al te veel tijd en kosten te moeten investeren.</p>
<p>Om het laatste puntje van mijn lijstje af te kunnen vinken heb ik hier een klein overzicht met een kosten indicatie van 3 verschillende providers waar je een docker Swarm cluster kan hosten. De totaal kosten welke hieronder staan zijn gebaseerd op 3 manager nodes en 2 worker nodes. De Manager nodes hebben allemaal 2 gig geheugen en de workers hebben 8 gig geheugen.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Provider</th>
<th style="text-align:left">Manager VM</th>
<th style="text-align:left">Worker VM</th>
<th style="text-align:left">Totaal</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://azure.microsoft.com/nl-nl/pricing/details/virtual-machines/ubuntu-advantage-standard/" target="_blank" rel="noopener">Azure</a></td>
<td style="text-align:left">B1MS      €32/mo</td>
<td style="text-align:left">B2MS      €76/mo</td>
<td style="text-align:left">€248/mo</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://www.digitalocean.com/pricing/#Compute" target="_blank" rel="noopener">Digital Ocean</a></td>
<td style="text-align:left">Standard  $10/mo</td>
<td style="text-align:left">Standard  $40/mo</td>
<td style="text-align:left">$110/mo</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://www.strato.nl/server/vps-linux/" target="_blank" rel="noopener">Strato</a></td>
<td style="text-align:left">Linux V10 €5/mo</td>
<td style="text-align:left">Linux V30 €15/mo</td>
<td style="text-align:left">€45/mo</td>
</tr>
</tbody>
</table>
<p>De kosten voor de Azure Traffic Manager zijn: Eerste 1 miljard DNS-query’s/maand    €0,456 per miljoen query’s. <a href="https://azure.microsoft.com/nl-nl/pricing/details/traffic-manager/" target="_blank" rel="noopener">https://azure.microsoft.com/nl-nl/pricing/details/traffic-manager/</a></p>
<p>Zoals je ziet in het overzicht 3 providers waarvan Digital Ocean en Azure echt serieuze cloud providers zijn met veel meer services dan alleen virtuele machines. Azure biedt een uptime van 99,9% en Digital Ocean een uptime van 99,99% dit is ook iets waar je voor betaald. Zo zie je dat voor iedereen zijn portemonnee een oplossing is. </p>
<p>Mocht je toch niet tevreden zijn met de service van je hosting provider dan is het heel gemakkelijk om je infrastructuur op te pakken en deze gewoon bij een andere provider te hosten. Het zijn namelijk gewoon container images en yaml files voor de configuratie en je bent in een mum van tijd weer up en running. </p>
<p>[^1]: Een service is een image van een microservice in de context van een grotere toepassing.<br>[^2]: Een stack is een Docker-compose file met services gedefinieerd welke in een keer uitgerold kan worden.<br>[^3]: Docker-Compose is een hulpmiddel voor het definiëren en uitvoeren van Docker-toepassingen met meerdere containers.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/11/03/Docker-Swarm/" data-id="ck3k8b2rp00016cunizflfpno" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker-swarm/" rel="tag">Docker swarm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Let-s-Encrypt/" rel="tag">Let's Encrypt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Portainer/" rel="tag">Portainer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Traefik/" rel="tag">Traefik</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CICD-SharePointFramework-part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/CICD-SharePointFramework-part-1/" class="article-date">
  <time datetime="2019-10-17T10:15:31.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/CICD-SharePointFramework-part-1/">Continuous Integration &amp; Deployment with SharePoint Framework Solutions - Part 1 of 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Microsoft heeft goed werk verricht voor ons als SPFx developers om met <em>gulp serve</em> snel te kunnen ontwikkelen binnen SharePoint Online. Je kunt lokaal je webpart testen en zelfs verbinden met live data binnen SharePoint Online zonder dat  het beschikbaar is voor anderen.</p>
<p>Als SPFx developer leveren we uiteindelijk ons SharePoint Online maatwerk aan onze klant. We zijn dan gewend de commando’s als <em>gulp bundle -ship</em> en <em>gulp package-solution -ship</em> uit te voeren en te uploaden naar onze App Catalog en te “Implementeren”. Maar hiervoor heb je rechten nodig en niet altijd ben je daarvoor bevoegd. Deze verantwoording is vaak belegd bij de applicatiebeheerder die verantwoordelijk is voor een stabiele applicatie.</p>
<p>Hoe fijn zou het zijn als je dit samen met de applicatiebeheerder kunt inregelen via Azure DevOps Continuous Integration en Deployment. Bij de Collaboration Summit in Wiesbaden in mei 2019 werd gedemonstreerd hoe dit ingeregeld kan worden. In deze blog ga ik dit met mijn Visual Studio Enterprise subscription in mijn Office 365 Developer tenant inrichten. Het doel van deel 1 van deze blog is wanneer dingen gecommit worden in de master-branch, dat die code gebuild wordt en de artifact ‘myproject.sppkg’ te downloaden is. In de volgende blog (Part 2) gaan we de installatie van deze package automatiseren met Continuous Deployment.</p>
<p><strong>Azure DevOps - Voorbereiding</strong><br>Voordat we de pipelines gaan inrichten, hebben we de volgende uitgangspunten:</p>
<ul>
<li>Broncode van een SPFx-webpart solution staat in een Git-repository in Azure DevOps.</li>
<li>De SPFx-webpart solution is buildable zonder fouten.</li>
<li>Je heb rechten binnen AzureDevOps om een Build-pipeline in te richten.</li>
</ul>
<p><strong>Azure DevOps - Maken van de Build-pipeline voor een SharePoint Framework project</strong><br>Er zijn verschillende manieren om een build-pipeline op te zetten. Als je voor het eerst begint met build-pipelines, dan is de simpelste manier om de ‘classic editor’ te gebruiken en hiermee te experimenteren. De definitie en alle wijzigingen die je op de build pipeline maakt staan los van de source code.<br>De andere manier is d.m.v. een YAML-file die wel naast de source code staat en dus mee moet komen in je commit. In deze blog maken we een SharePoint Framework Build pipeline dmv een YAML-file:</p>
<ul>
<li>Ga naar je Azure DevOps project en ga naar ‘Pipelines’ -&gt; ‘Build’.</li>
<li>Maak een nieuwe Build pipeline aan.<br><img src="/images/cicd-sharepointframework/01-newbuildpipeline.png"></li>
<li>Kies vervolgens bij ‘Where is your code?’ voor ‘Azure Repos Git’ als je code standaard in Azure DevOps staat met Git. </li>
<li>Kies vervolgens je Repository.</li>
<li><p>Kies vervolgens bij ‘Configure your pipeline’ voor de optie ‘Starter pipeline’.<br><img src="/images/cicd-sharepointframework/02-yaml-initialcode.png"><br><em>Figuur 1: Initiële yaml-code</em></p>
</li>
<li><p>Vervang de initiële code met het volgende:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># Deze build start wanneer er een wijziging op de &apos;master&apos;-branch wordt gedaan.</span><br><span class="line">trigger:</span><br><span class="line">- master</span><br><span class="line"></span><br><span class="line"># We gebruiken een hosted VM met Visual Studio 2017 op een Windows 2016 server van Azure</span><br><span class="line">pool:</span><br><span class="line">  vmImage: &apos;vs2017-win2016&apos;</span><br><span class="line">  </span><br><span class="line">steps:</span><br><span class="line"># Installeer Node 8.x</span><br><span class="line">- task: UseNode@1</span><br><span class="line">  displayName: &apos;Install Node 8.x&apos;</span><br><span class="line">  inputs:</span><br><span class="line">    version: &apos;8.x&apos;</span><br><span class="line"># Installeer alle packages van het project met Node</span><br><span class="line">- task: Npm@1</span><br><span class="line">  displayName: &apos;Run &apos;&apos;npm install&apos;&apos;&apos;</span><br><span class="line">  inputs:</span><br><span class="line">    command: &apos;install&apos;</span><br><span class="line"># Gulp-commando: Verzamelen van alle broncode van het SharePoint Framework-project</span><br><span class="line">- task: Gulp@1</span><br><span class="line">  displayName: &apos;Run &apos;&apos;gulp bundle --ship&apos;&apos;&apos;</span><br><span class="line">  inputs:</span><br><span class="line">    gulpFile: &apos;gulpfile.js&apos;</span><br><span class="line">    targets: &apos;bundle&apos;</span><br><span class="line">    arguments: &apos;--ship&apos;</span><br><span class="line">    enableCodeCoverage: false</span><br><span class="line"># Gulp-commando: Maak een solution package van het SharePoint Framework-project</span><br><span class="line">- task: Gulp@1</span><br><span class="line">  displayName: &apos;Run &apos;&apos;gulp package-solution --ship&apos;&apos;&apos;</span><br><span class="line">  inputs:</span><br><span class="line">    gulpFile: &apos;gulpfile.js&apos;</span><br><span class="line">    targets: &apos;package-solution&apos;</span><br><span class="line">    arguments: &apos;--ship&apos;</span><br><span class="line">    enableCodeCoverage: false</span><br><span class="line"># Publiceer de SharePoint Solution Package onder de artifact naam &apos;SPFx-myproject&apos;</span><br><span class="line">- task: PublishPipelineArtifact@1</span><br><span class="line">  displayName: &apos;Publish &apos;&apos;MyProject&apos;&apos; to artifact &apos;&apos;SPFx-myproject&apos;&apos;&apos;</span><br><span class="line">  inputs:</span><br><span class="line">    targetPath: &apos;sharepoint/solution/myproject-webpart.sppkg&apos;</span><br><span class="line">    artifact: &apos;SPFx-myproject&apos;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><em>Figuur 2: Standaard yaml build pipeline voor ‘myproject’</em></p>
<ul>
<li>Pas indien nodig alle ‘myproject’ teksten aan naar wens.</li>
<li>Klik op ‘Save &amp; Run’<br><img src="/images/cicd-sharepointframework/03-yaml-save-and-run.png"><br><em>Figuur 3: Save and run build pipeline</em></li>
</ul>
<p>Je ziet hier dat je je wijziging direct in de master-branch kan aanbrengen of apart in een Pull Request in een nieuwe branch. Voor nu kiezen we voor ‘Commit directly to the master branch’.</p>
<ul>
<li>De build gaat van start:<br><img src="/images/cicd-sharepointframework/04-build-running.png"><br><em>Figuur 4: Azure built nu MyProject-artifact</em></li>
<li>Na enkele minuten is de build klaar en verschijnt rechtsboven in het scherm de knop ‘Artifacts’.<br>Onder deze knop kan de package gedownload worden.<br><img src="/images/cicd-sharepointframework/05-build-finished.png"><br><em>Figuur 5: Artifact is gebuild en te downloaden</em></li>
</ul>
<p>In de volgende blog gaan we deze package installeren via Continuous Deployment.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/10/17/CICD-SharePointFramework-part-1/" data-id="ck3k8b2rg00006cuns0zw55wo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Continuous-Deployment/" rel="tag">Continuous Deployment</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Continuous-Integration/" rel="tag">Continuous Integration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Frontend/" rel="tag">Frontend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Office-365/" rel="tag">Office 365</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPFx/" rel="tag">SPFx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharePoint-Framework/" rel="tag">SharePoint Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharePoint-Online/" rel="tag">SharePoint Online</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpart/" rel="tag">Webpart</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Proof-of-concept-met-azure-batch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/27/Proof-of-concept-met-azure-batch/" class="article-date">
  <time datetime="2019-06-27T17:54:37.000Z" itemprop="datePublished">2019-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/27/Proof-of-concept-met-azure-batch/">Proof of concept met Azure Batch</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Case-omschrijving"><a href="#Case-omschrijving" class="headerlink" title="Case omschrijving "></a>Case omschrijving </h2><p>Net als in mijn vorige <a href="https://cloudrepublic.github.io/2019/03/28/Proof-of-concept-met-durable-functions/">blog post</a> heb ik een Proof of Concept gemaakt om grote hoeveelheden XML bestanden te transformeren, het gaat dan 3000 bestanden per keer met een totale grote van 18 gigabyte. Voor dit artikel kan ik wegens privacy redenen niet de echte data gebruiken en heb ik een dataset gebruikt van <a href="https://www.kaggle.com/datasets" target="_blank" rel="noopener">https://www.kaggle.com/datasets</a>. Het gaat hier om een dataset van landen en de wijnen.</p>
<p>Het doel is om de wijnen uit de XML dump te halen en deze om te zetten naar een JSON formaat en deze bestanden te uploaden in een blob container. We krijgen dus per wijn een JSON bestand in een blob container. Dit alles moet gebeuren op basis Azure Batch met een Azure Function als orchestrator.</p>
<h2 id="Wat-is-de-opzet-van-de-POC"><a href="#Wat-is-de-opzet-van-de-POC" class="headerlink" title="Wat is de opzet van de POC"></a>Wat is de opzet van de POC</h2><p>We gaan de XML bestanden transformeren doormiddel van een Azure Batch component en we starten en beheren de Azure Batch doormiddel van een Azure Function.<br>De Azure Function zal de XML bestanden toevoegen aan een Job in Azure Batch doormiddel van een <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-event-grid" target="_blank" rel="noopener">event grid trigger</a> en via een httptrigger is de voortgang te zien van het batch proces. </p>
<p><img src="/images/azure-batch-overview.png"></p>
<h2 id="Wat-is-Azure-Batch"><a href="#Wat-is-Azure-Batch" class="headerlink" title="Wat is Azure Batch"></a>Wat is Azure Batch</h2><p>Azure Batch is plat gezegd eigenlijk een beheer tool voor virtuele machines. Elk van deze machines kan een taak oppakken en dit als input gebruiken voor een commandline applicatie en het resultaat uploaden in bijvoorbeeld een blob container. </p>
<p>Voor de complete omschrijving wat je met Azure Batch kunt doen verwijs ik je graag door naar de Microsoft site <a href="https://azure.microsoft.com/nl-nl/services/batch/" target="_blank" rel="noopener">https://azure.microsoft.com/nl-nl/services/batch/</a></p>
<h2 id="Hoe-werkt-het-Proof-of-Concept"><a href="#Hoe-werkt-het-Proof-of-Concept" class="headerlink" title="Hoe werkt het Proof of Concept"></a>Hoe werkt het Proof of Concept</h2><p>Azure Batch bestaat uit een aantal componenten.</p>
<ul>
<li>Een Task is een opdracht welke uitgevoerd dient te worden op een node. </li>
<li>Een Job is een verzameling van tasks. Aan een Job hangt ook een Pool.</li>
<li>Een Pool is een verzameling van nodes.</li>
<li>Een Node is een virtuele machine welke een van de tasks gaat uitvoeren. </li>
</ul>
<p>Ik heb 40 bestanden met landen en wijnen. 1 bestand is ongeveer 75 mb groot. Voor testdoeleinden zijn dit dezelfde bestanden met een andere naam. Dit is meer om een gelijkwaardige load op de functie te krijgen als bij de echte POC.</p>
<p>Ik heb een Azure Function welke een event grid trigger heeft welke afgaat op het moment dat er een bestand wordt geupload in de blobcontainer.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"BatchOrchestrator"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">   [EventGridTrigger] EventGridEvent eventGridEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">   ExecutionContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">   ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;StorageBlobCreatedEventData&gt;(eventGridEvent.Data.ToString());</span><br><span class="line">   <span class="keyword">string</span> name = data.Url.Split(<span class="string">'/'</span>).Last();</span><br><span class="line"></span><br><span class="line">   log.LogInformation(<span class="string">$"C# Blob trigger function Processed blob\n Name:<span class="subst">&#123;name&#125;</span>"</span>);</span><br><span class="line">   <span class="keyword">await</span> RunBatch(log, context, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>De bestandsnaam wordt uit de URL gehaald en doorgestuurd naar de methode RunBatch.<br>De methode RunBatch initialiseert een BatchClient met de credentials welke opgegeven zij in de config.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">    BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">    <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Hierna gaan we kijken of er al een job bestaat in het Azure Batch Account. Als er al een job bestaat en hij is nog actief of wordt aangemaakt voegen we hier een task aan toe. Als er geen job actief is of wordt opgestart dan maken we een Job aan. Dit gebeurt in de <em>CreateJob</em> methode.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">    BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">    <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> jobId = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            batchClient.CustomBehaviors.Add(RetryPolicyProvider.ExponentialRetryProvider(TimeSpan.FromSeconds(<span class="number">5</span>), <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (batchClient.JobOperations.ListJobs().Any())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                CloudJob activeJob = jobs.FirstOrDefault(job =&gt; job.State == JobState.Active || job.State == JobState.Enabling);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (activeJob != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.LogDebug(<span class="string">"Job still active"</span>);</span><br><span class="line">                    CreateTaskIfNotExists(batchClient, activeJob.Id, name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            log.LogError(e, e.Message);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(jobId))</span><br><span class="line">            &#123;</span><br><span class="line">                log.LogDebug(<span class="string">$"Deleting job: <span class="subst">&#123;jobId&#125;</span>"</span>);</span><br><span class="line">                <span class="keyword">await</span> batchClient.JobOperations.DeleteJobAsync(jobId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Een Job heeft een pool met nodes nodig welke het werk uitvoeren. We gaan deze dus eerst aanmaken.</p>
<ul>
<li>We specificeren het besturingssysteem in dit geval staat de waarde <em>5</em> voor <em>Windows Server 2016</em> voor de overige waardes check de Azure Guest OS Releases <a href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-guestos-update-matrix#releases" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-guestos-update-matrix#releases</a></li>
<li>We specificeren een virtuele machine size in dit geval een <em>standard_d1_v2</em> voor de overige ondersteunde machines check <a href="https://docs.microsoft.com/en-us/azure/batch/batch-pool-vm-sizes#supported-vm-families-and-sizes" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-pool-vm-sizes#supported-vm-families-and-sizes</a></li>
<li>We specificeren hoeveel tasks er per node gedraaid mogen worden in dit geval 4. Er zullen dus 4 tasks per keer op de node worden gestart.</li>
<li>We specificeren welke applicatie er op de node gedraaid dient te worden. Dit moet een applicatie of script zijn welke via de commandline te draaien is. Deze applicatie kan als een zip bestand worden gupload in de portal. </li>
<li>We zetten de lifetime op <em>PoolLifetimeOption.Job</em> dit wil zeggen zodra alle tasks in de Job klaar zijn zal de pool verwijdert worden en zul je dus ook niet meer betalen voor de virtuele machines. </li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PoolInformation <span class="title">CreatePool</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PoolInformation()</span><br><span class="line">    &#123;</span><br><span class="line">        AutoPoolSpecification = <span class="keyword">new</span> AutoPoolSpecification()</span><br><span class="line">        &#123;</span><br><span class="line">            AutoPoolIdPrefix = <span class="string">"Wine"</span>,</span><br><span class="line">            PoolSpecification = <span class="keyword">new</span> PoolSpecification()</span><br><span class="line">            &#123;</span><br><span class="line">                CloudServiceConfiguration = <span class="keyword">new</span> CloudServiceConfiguration(<span class="string">"5"</span>),</span><br><span class="line">                VirtualMachineSize = <span class="string">"standard_d1_v2"</span>,</span><br><span class="line">                MaxTasksPerComputeNode = <span class="number">4</span>,</span><br><span class="line">                ApplicationPackageReferences = <span class="keyword">new</span> List&lt;ApplicationPackageReference&gt;()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> ApplicationPackageReference()</span><br><span class="line">                    &#123;</span><br><span class="line">                        ApplicationId = <span class="string">"converter"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            KeepAlive = <span class="literal">false</span>,</span><br><span class="line">            PoolLifetimeOption = PoolLifetimeOption.Job</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nu we een Pool hebben kunnen we deze koppelen aan de Job. De <em>CreateJob</em> methode maakt een unieke naam aan voor de job doormiddel van een timestamp te prefixen met “WineConverter”.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">string</span>&gt; <span class="title">CreateJob</span>(<span class="params"><span class="keyword">string</span> name, BatchClient batchClient</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> jobId;</span><br><span class="line"></span><br><span class="line">    CloudJob activeJob;</span><br><span class="line">    jobId = CreateJobId(<span class="string">"WineConverter"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create pool</span></span><br><span class="line">    PoolInformation pool = CreatePool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a job</span></span><br><span class="line">    activeJob = <span class="keyword">await</span> CreateJobAsync(batchClient, jobId, pool);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create tasks from the blobs</span></span><br><span class="line">    CreateTaskIfNotExists(batchClient, jobId, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> activeJob.RefreshAsync();</span><br><span class="line">    activeJob.OnAllTasksComplete = OnAllTasksComplete.TerminateJob;</span><br><span class="line">    <span class="keyword">await</span> activeJob.CommitChangesAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jobId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We controlleren eerst of de task al is aangemaakt en is toegevoegd aan de job, zoniet dan voegen we hem toe. De naam van de task mag alleen letters en cijfers bevatten en een koppelteken en underscore.</p>
<p>Ook stellen we in welke package de task moet starten met welke argumenten. Hier starten we converter.exe met als argument een naam van de blob (in dit geval een XML bestand met wijn data).</p>
<p>De converter.exe bevat alle logica om de xml te verwerken en het resultaat te uploaden in een Azure blob container.<br>In de Azure portal kan je een package uploaden welke op de nodes geinstalleerd moeten worden. Meer informatie over hoe packages werken met Azure batch is te vinden op: <a href="https://docs.microsoft.com/en-us/azure/batch/batch-application-packages" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-application-packages</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateTaskIfNotExists</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, <span class="keyword">string</span> blobName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IPagedEnumerable&lt;CloudTask&gt; tasks = batchClient.JobOperations.ListTasks(jobId);</span><br><span class="line">    <span class="keyword">string</span> taskId = <span class="string">$"task_<span class="subst">&#123;SanitizeString(blobName)&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tasks.Any(x =&gt; x.Id == taskId))</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$"Task with id: <span class="subst">&#123;taskId&#125;</span> all ready exists"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    batchClient.JobOperations.AddTask(jobId, <span class="keyword">new</span> CloudTask(taskId, <span class="string">$"cmd /c %AZ_BATCH_APP_PACKAGE_CONVERTER%\\converter.exe -name <span class="subst">&#123;blobName&#125;</span>"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="De-volledige-code"><a href="#De-volledige-code" class="headerlink" title="De volledige code"></a>De volledige code</h2><p>Zie hieronder de volledige code. Er is een extra function aan toegevoegd met een httptrigger zodra je deze aanroept worden alle jobs met de bijhorende tasks weergegeven en de status van de tasks. Het endpoint is nu niet beveiligd maar dit is omdat het een demo is.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch.Auth;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Batch.Common;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.WebJobs;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.WebJobs.Extensions.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> JobState = Microsoft.Azure.Batch.Common.JobState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WineConverter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BatchOrchestrator</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">FunctionName(<span class="meta-string">"BatchOrchestrator"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">           [EventGridTrigger] EventGridEvent eventGridEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">           ExecutionContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">           ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">           <span class="keyword">var</span> data = JsonConvert.DeserializeObject&lt;StorageBlobCreatedEventData&gt;(eventGridEvent.Data.ToString());</span><br><span class="line">           <span class="keyword">string</span> name = data.Url.Split(<span class="string">'/'</span>).Last();</span><br><span class="line"></span><br><span class="line">           log.LogInformation(<span class="string">$"C# Blob trigger function Processed blob\n Name:<span class="subst">&#123;name&#125;</span>"</span>);</span><br><span class="line">           <span class="keyword">await</span> RunBatch(log, context, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">RunBatch</span>(<span class="params">ILogger log, ExecutionContext context, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line"></span><br><span class="line">            BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">            <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> jobId = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    batchClient.CustomBehaviors.Add(RetryPolicyProvider.ExponentialRetryProvider(TimeSpan.FromSeconds(<span class="number">5</span>), <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (batchClient.JobOperations.ListJobs().Any())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                        CloudJob activeJob = jobs.FirstOrDefault(job =&gt; job.State == JobState.Active || job.State == JobState.Enabling);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (activeJob != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            log.LogDebug(<span class="string">"Job still active"</span>);</span><br><span class="line">                            CreateTaskIfNotExists(batchClient, activeJob.Id, name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        jobId = <span class="keyword">await</span> CreateJob(name, batchClient);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    log.LogError(e, e.Message);</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(jobId))</span><br><span class="line">                    &#123;</span><br><span class="line">                        log.LogDebug(<span class="string">$"Deleting job: <span class="subst">&#123;jobId&#125;</span>"</span>);</span><br><span class="line">                        <span class="keyword">await</span> batchClient.JobOperations.DeleteJobAsync(jobId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">FunctionName(<span class="meta-string">"BatchStatus"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">BatchStatus</span>(<span class="params">[HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">"get"</span></span>)]HttpRequestMessage req, ExecutionContext context, ILogger log)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            List&lt;Job&gt; jobList = <span class="keyword">new</span> List&lt;Job&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> config = ReadSettings(context);</span><br><span class="line">            BatchSharedKeyCredentials credentials = <span class="keyword">new</span> BatchSharedKeyCredentials(config[<span class="string">"BatchUrl"</span>], config[<span class="string">"BatchAccount"</span>], config[<span class="string">"BatchKey"</span>]);</span><br><span class="line">            <span class="keyword">using</span> (BatchClient batchClient = BatchClient.Open(credentials))</span><br><span class="line">            &#123;</span><br><span class="line">                IPagedEnumerable&lt;CloudJob&gt; jobs = batchClient.JobOperations.ListJobs();</span><br><span class="line">                <span class="keyword">if</span> (jobs.Any())</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (CloudJob cloudJob <span class="keyword">in</span> jobs.ToList())</span><br><span class="line">                    &#123;</span><br><span class="line">                        jobList.Add(<span class="keyword">new</span> Job()</span><br><span class="line">                        &#123;</span><br><span class="line">                            Id = cloudJob.Id,</span><br><span class="line">                            Name = cloudJob.DisplayName,</span><br><span class="line">                            Status = cloudJob.State.ToString(),</span><br><span class="line">                            Tasks = cloudJob.ListTasks().Select(task =&gt; <span class="keyword">new</span> JobTask()</span><br><span class="line">                            &#123;</span><br><span class="line">                               Id = task.Id,</span><br><span class="line">                               Name = task.DisplayName,</span><br><span class="line">                               Status = task.State.ToString()</span><br><span class="line">                            &#125;).ToList()</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> JsonConvert.SerializeObject(jobList, Formatting.Indented);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">string</span>&gt; <span class="title">CreateJob</span>(<span class="params"><span class="keyword">string</span> name, BatchClient batchClient</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> jobId;</span><br><span class="line"></span><br><span class="line">            CloudJob activeJob;</span><br><span class="line">            jobId = CreateJobId(<span class="string">"WineConverter"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create pool</span></span><br><span class="line">            PoolInformation pool = CreatePool();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// create a job</span></span><br><span class="line">            activeJob = <span class="keyword">await</span> CreateJobAsync(batchClient, jobId, pool);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create tasks from the blobs</span></span><br><span class="line">            CreateTaskIfNotExists(batchClient, jobId, name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> activeJob.RefreshAsync();</span><br><span class="line">            activeJob.OnAllTasksComplete = OnAllTasksComplete.TerminateJob;</span><br><span class="line">            <span class="keyword">await</span> activeJob.CommitChangesAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> jobId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PoolInformation <span class="title">CreatePool</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PoolInformation()</span><br><span class="line">            &#123;</span><br><span class="line">                AutoPoolSpecification = <span class="keyword">new</span> AutoPoolSpecification()</span><br><span class="line">                &#123;</span><br><span class="line">                    AutoPoolIdPrefix = <span class="string">"Wine"</span>,</span><br><span class="line">                    PoolSpecification = <span class="keyword">new</span> PoolSpecification()</span><br><span class="line">                    &#123;</span><br><span class="line">                        CloudServiceConfiguration = <span class="keyword">new</span> CloudServiceConfiguration(<span class="string">"5"</span>),</span><br><span class="line">                        VirtualMachineSize = <span class="string">"standard_d1_v2"</span>,</span><br><span class="line">                        MaxTasksPerComputeNode = <span class="number">4</span>,</span><br><span class="line">                        ApplicationPackageReferences = <span class="keyword">new</span> List&lt;ApplicationPackageReference&gt;()</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">new</span> ApplicationPackageReference()</span><br><span class="line">                            &#123;</span><br><span class="line">                                ApplicationId = <span class="string">"converter"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    KeepAlive = <span class="literal">false</span>,</span><br><span class="line">                    PoolLifetimeOption = PoolLifetimeOption.Job</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;CloudJob&gt; <span class="title">CreateJobAsync</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, PoolInformation pool</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CloudJob unboundJob = batchClient.JobOperations.CreateJob();</span><br><span class="line">            unboundJob.Id = jobId;</span><br><span class="line"></span><br><span class="line">            unboundJob.PoolInformation = pool;</span><br><span class="line">            <span class="keyword">await</span> unboundJob.CommitAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> unboundJob;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateTaskIfNotExists</span>(<span class="params">BatchClient batchClient, <span class="keyword">string</span> jobId, <span class="keyword">string</span> blobName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IPagedEnumerable&lt;CloudTask&gt; tasks = batchClient.JobOperations.ListTasks(jobId);</span><br><span class="line">            <span class="keyword">string</span> taskId = <span class="string">$"task_<span class="subst">&#123;SanitizeString(blobName)&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tasks.Any(x =&gt; x.Id == taskId))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$"Task with id: <span class="subst">&#123;taskId&#125;</span> all ready exists"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            batchClient.JobOperations.AddTask(jobId, <span class="keyword">new</span> CloudTask(taskId, <span class="string">$"cmd /c %AZ_BATCH_APP_PACKAGE_CONVERTER%\\converter.exe -name <span class="subst">&#123;blobName&#125;</span>"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">CreateJobId</span>(<span class="params"><span class="keyword">string</span> prefix</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$"<span class="subst">&#123;prefix&#125;</span>-<span class="subst">&#123;DateTime.Now:yyyyMMdd-HHmmss&#125;</span>"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">SanitizeString</span>(<span class="params"><span class="keyword">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> pattern = <span class="string">@"[^A-Za-z0-9-_]"</span>;</span><br><span class="line">            <span class="keyword">return</span> System.Text.RegularExpressions.Regex.Replace(text, pattern, <span class="keyword">string</span>.Empty);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IConfigurationRoot <span class="title">ReadSettings</span>(<span class="params">ExecutionContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">                .SetBasePath(context.FunctionAppDirectory)</span><br><span class="line">                .AddJsonFile(<span class="string">"local.settings.json"</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>)</span><br><span class="line">                .AddEnvironmentVariables()</span><br><span class="line">                .Build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JobTask</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Status &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Job</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Status &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;JobTask&gt; Tasks &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conclusie"><a href="#Conclusie" class="headerlink" title="Conclusie"></a>Conclusie</h2><p>Azure batch is echt een serieuze keuze als je grote hoeveelheden data moet verwerken en je wilt in controle zijn wat er allemaal gebeurt.<br>Je kan zowel horizontaal als verticaal schalen en het aantal nodes wat het werk kan doen is standaard 20 maar je kunt een request doen voor meer nodes. Voor de recource limieten check de documentatie <a href="https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit</a>.</p>
<p>Ik ken zelf weinig projecten waar ze Azure batch gebruiken maar ik ben echt onder de indruk hoe simpel en krachtig Azure batch is plus je betaald alleen voor de tijd dat de nodes ook echt iets doen dus geen vaste maandelijkse kosten.</p>
<p>Deze POC heeft het qua performance zijn doel wel behaald wat we voor ogen hadden alleen het bevat toch net te veel stappen om het volledig via CI/CD gemakkelijk te deployen. </p>
<p>In een volgende blog zal ik de uiteindelijke oplossing uitwerken met verschillende functie apps op een consumption plan welke aan alle eisen voldoet.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/06/27/Proof-of-concept-met-azure-batch/" data-id="cjxfqz4xm0000xgunr03325se" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Getting-started-with-SPfx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/14/Getting-started-with-SPfx/" class="article-date">
  <time datetime="2019-06-14T14:15:35.000Z" itemprop="datePublished">2019-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/14/Getting-started-with-SPfx/">Getting started with SharePoint Framework</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Voor een klant zijn we begonnen met het bouwen van hun eerste SharePoint Online webpart. Binnen een Citrix omgeving waar we een Developer VM ter beschikking hebben, moeten we eerst een ontwikkelomgeving opzetten. Voor SharePoint on-premises developers is het een enorme omslag hoe dingen nu ontwikkeld worden met Javascript. Je krijgt te maken met NodeJS, NPM, gulp, Yeoman, etc. om maar wat termen te noemen. Als je ervaring hebt met frontend-ontwikkelen, dan ligt de moeilijkheid in het begrijpen van de (misschien onlogische) concepten van SharePoint Online.</p>
<p>Door simpelweg de instructies te volgen die te vinden is op <a href="https://docs.microsoft.com" target="_blank" rel="noopener">https://docs.microsoft.com</a> kom je er niet helemaal. Wat ik recent bent tegengekomen is dat er fouten staan omdat de gebruikte tooling online vernieuwd zijn, maar nog niet verwerkt zijn in het SharePoint Framework. Dit geeft als resultaat dat de uitgevoerde commando’s succesvol gelukt zijn met fouten….</p>
<p><img src="/images/getting-started-with-spfx/why-successfull-with-errors.png"></p>
<p>De oplossing: Wees niet eigenwijs door altijd de laatste versie te downloaden omdat het beter is (I did this…), maar download specifieke oude versies want onderhoud van gerelateerde componenten is complex. Je doel is om een webpart te maken wat uiteindelijk javascript is. Ik vertrouw erop dat Microsoft dit op zijn tijd zal vernieuwen.</p>
<p>Om heel wat frustraties (die ik had) je te besparen, heb ik de volgende stappen opgesteld zodat je als startende SPFx-developer snel van start kan gaan met het SharePoint Framework:</p>
<ul>
<li>Zet eerst een gratis Developer Tenant op volgens deze instructies:<br><a href="https://docs.microsoft.com/en-us/sharepoint/dev/spfx/set-up-your-developer-tenant" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sharepoint/dev/spfx/set-up-your-developer-tenant</a>.</li>
<li>Maak je development omgeving op volgens deze instructies, maar sla <strong>Trusting the self-signed developer certificate</strong> over:<br><a href="https://docs.microsoft.com/en-us/sharepoint/dev/spfx/set-up-your-development-environment" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sharepoint/dev/spfx/set-up-your-development-environment</a>.</li>
<li>Noteer de benodigde urls die je vaak nodig zult hebben<br><strong>Developer-account</strong>: <em>[my-name]@[my-tenant].onmicrosoft.com</em><br><strong>SharePoint Admin-Tenant</strong>: <em>https://[my-tenant]-admin.sharepoint.com</em><br><strong>App Catalog</strong>: <em>https://[my-tenant].sharepoint.com/sites/appcatalog/SitePages/Introductiepagina.aspx</em><br><strong>(Modern) Developer Site</strong>: <em>https://[my-tenant].sharepoint.com/sites/DeveloperModern</em></li>
<li>Installeer NodeJS 10.15.3 (geen nieuwere versie):<br><a href="https://nodejs.org/dist/v10.15.3/node-v10.15.3-x6msi" target="_blank" rel="noopener">https://nodejs.org/dist/v10.15.3/node-v10.15.3-x6msi</a></li>
<li>Installeer Python 2.7 (geen nieuwere versie):<br><a href="https://www.python.org/download/releases/2.7/" target="_blank" rel="noopener">https://www.python.org/download/releases/2.7/</a></li>
<li>In de command-prompt, maak nieuwe folder aan waar je de sources wilt hebben.<br>Voor de niet-DOS generatie developers hier de commando’s om op je C-schijf in de root een map aan te maken:<br><strong>C:</strong><br><strong>md myfirstwebpart</strong><br><strong>cd myfirstwebpart</strong></li>
<li>SharePoint project aanmaken met volgende commando:<br><strong>yo @microsoft/sharepoint</strong><br>Beantwoord vervolgens de vragen die gesteld worden.</li>
<li>Voor de zekerheid alle packages installeren van dit project met volgende commando:<br><strong>Npm install</strong></li>
<li>Development certificaat vertrouwen met volgende commando:<br><strong>gulp trust-dev-cert</strong><br><img src="/images/getting-started-with-spfx/dev-spfx-cert.png"><br>Opmerking: Op de site van docs.microsoft.com stond deze stap boven het maken van een nieuw SPFx-project met yo@microsoft/sharepoint. Niet handig als je nog niet weet dat je een nieuw project gaat maken en zelf mag kiezen.<br><img src="/images/getting-started-with-spfx/trust-self-signed-dev-cert.png"></li>
<li>Bundel alle assets voor development doeleinde (gehost op <a href="https://localhost:xxxx" target="_blank" rel="noopener">https://localhost:xxxx</a>) met volgende commando:<br><strong>gulp bundle</strong></li>
<li>Maak de SharePoint-package voor development doeleinde (gehost op <a href="https://localhost:xxxx" target="_blank" rel="noopener">https://localhost:xxxx</a>) met volgende commando:<br><strong>gulp package-solution</strong><br>De uitvoer van dit commando komt terecht in de map ./sharepoint/solution<br>De SharePoint-package is het bestand eindigend met <strong>.sppkg</strong>.</li>
<li>Start je lokale webserver en de Workbench met het volgende commando:<br><strong>Gulp serve</strong></li>
</ul>
<p>Nu kun je aan de slag met Workbench welke automatisch gestart wordt. Je kunt het webpart toevoegen op de pagina en beginnen met ontwikkelen in Visual Studio Code. Let op: Je hebt nu geen beschikking tot data of SharePoint API’s. Het is de bedoeling dat je eerst de UI ontwikkelt en fictieve data maakt en gebruikt. Zorg dat <strong>gulp serve</strong> in de command-prompt blijft draaien. Dit is je lokale webserver van je webpart! Elke keer als je iets aanpast, compileert <strong>gulp serve</strong> je code en ververst automatisch in je browser de Workbench.</p>
<p><strong>Klaar met mockdata en wil je ontwikkelen in SharePoint Online zodat je over de echte data beschikt van Graph en SharePoint?</strong></p>
<ul>
<li>Voer de volgende commando’s uit:<br><strong>gulp bundle</strong><br><strong>gulp package-solution</strong></li>
<li>Upload en ‘implementeer’ (installeer) de SharePoint-package (.sppkg) naar je eerder ingerichte App-Catalog site:<br>bijv.: https://[my-tenant].sharepoint.com/sites/appcatalog/AppCatalog/Forms/AllItems.aspx</li>
</ul>
<p>Nu kun je de app installeren op elke SharePoint site als site beheerder en vervolgens de webpart op een willekeurige plek in je site plaatsen. Je hebt dan ook volledig beschikking tot de API’s van Graph en SharePoint.<br><em>Let op dat je webpart ‘werkt’ zolang <strong>gulp serve</strong> op de achtergrond draait en als iemand op een ander apparaat dezelfde pagina benaderdt, deze een technische foutmelding krijgt</em></p>
<p><strong>Klaar met ontwikkelen en wil je je ontwikkelde webpart deployen naar Test, Acceptatie en Productie?</strong></p>
<ul>
<li>Voer de volgende commando’s uit:<br><strong>gulp bundle –ship</strong><br><strong>gulp package-solution –ship</strong></li>
<li>Upload en ‘implementeer’ (installeer) de SharePoint-package (.sppkg) naar de App-Catalog site van gewenste tenant:<br>bijv.: https://[test/acc/prod-tenant].sharepoint.com/sites/appcatalog/AppCatalog/Forms/AllItems.aspx</li>
</ul>
<p>Nu kun je de app installeren op elke SharePoint site als site beheerder en vervolgens de webpart op een willekeurige plek in je site plaatsen. Iedereen kan de webpart gebruiken en ook op telefoon en tablet via de SharePoint App.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/06/14/Getting-started-with-SPfx/" data-id="cjx635wve0000bcuny9o10sds" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Frontend/" rel="tag">Frontend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gulp/" rel="tag">Gulp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Office-365/" rel="tag">Office 365</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SPFx/" rel="tag">SPFx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharePoint-Framework/" rel="tag">SharePoint Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharePoint-Online/" rel="tag">SharePoint Online</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpart/" rel="tag">Webpart</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Workbench/" rel="tag">Workbench</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-follow-the-moon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/22/follow-the-moon/" class="article-date">
  <time datetime="2019-05-22T16:00:00.000Z" itemprop="datePublished">2019-05-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/22/follow-the-moon/">Following the moon</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In the ideal situation, we would like to release our new code with zero downtime. It is very possible that this can be done by releasing to a separate staging slot and then swapping this with the production slot. Should be zero downtime. However, there are always cases where this does not apply, where downtime can only be avoided through tedious manual intervention and multiple failover steps. Say we have an application that runs globally and we have such a case. Or if we just really, really want to make sure that our customers have as few problems as possible.</p>
<p>In this case, we propose to use the follow-the-moon (FTM) release schedule. This means releasing our application at times in different regions where for each region, the time we release at is the time where it is least likely that a customer is using the application. And yes, we know that the moon can be visible during the day, but you get the sentiment.</p>
<p>You will still want to have the entry point of your application to send your users to a region you host your application in that is 1) available and 2) close to the user. Taking a region down to release a new version of your application is still not desired, as it will either not be rerouted (e.g. because of caching) and thus will result in routing to an application that is down, or be rerouted to a region where the distance can cause undesirable increases in response times. Thus, we would like to make sure to do the release at a time where it is convenient per region, not all at once.</p>
<p>In the FTM release schedule, we may, for example, set the release time for each region to 03:00 local time. Once we approve the continuation of the release, the schedule will start to kick in and release our application to all regions at their respective optimal times. This means that our application is rolled out automatically, in different time zones, without the need for manual intervention in our multi-region roll-out process.</p>
<p>Getting our application to production globally could involve the following:</p>
<ul>
<li>Set up a continuous integration build to automate building your code</li>
<li>Set up an automatic release pipeline, automatically started from artifacts, going through multiple stages with certain filters on source branches</li>
<li>Set up the follow-the-moon release schedule for our production releases to multiple regions</li>
</ul>
<h2 id="Getting-to-the-moon"><a href="#Getting-to-the-moon" class="headerlink" title="Getting to the moon"></a>Getting to the moon</h2><p>For this part, we assume your project has some code and a build is in place to create artifacts which we can work with.</p>
<p>Suppose our release pipeline looks like this:</p>
<p><img src="/images/follow-the-moon/follow-the-moon-1.jpg"></p>
<p>We have our artifact as an entry point. We have our DEV and TST environments hooked up for continuous releases based on the develop branch. Finally, we have our ACC and PRD environments hooked up for continuous releases based on the master branch. In this case, we want to double-check the ACC environment before actually rolling out to PRD, so we add a post-deployment approval condition there.</p>
<p>Now, if we click on the pre-deployment conditions, we see the following menu:</p>
<p><img src="/images/follow-the-moon/follow-the-moon-2.jpg"></p>
<p>We enable the schedule and set it to the time where we expect our users to not use the application in that region. For example, in the WE (West Europe) Azure region, at 03:00 would be when we expect our customers to sleep, so we may decide that this is the right time to deploy.</p>
<p><img src="/images/follow-the-moon/follow-the-moon-3.jpg"></p>
<p>After we have done this for all the production environments, we have successfully implemented the FTM release schedule! Do note that using swap slots is still what you want to do. However, this principle gives us a little bit of extra safety when releasing code that may otherwise cause downtime.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/05/22/follow-the-moon/" data-id="cjx635wvi0001bcunou5oi6k1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Release-pipeline/" rel="tag">Release pipeline</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Release-schedule/" rel="tag">Release schedule</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Microsoft-Build-2019-Must-Watch-Guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/09/Microsoft-Build-2019-Must-Watch-Guide/" class="article-date">
  <time datetime="2019-05-09T16:00:00.000Z" itemprop="datePublished">2019-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/09/Microsoft-Build-2019-Must-Watch-Guide/">Microsoft Build 2019 Must Watch Guide</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p></p><p>6 Mei tot 8 Mei vond het jaarlijkse event voor Microsoft ontwikkelaars plaats, namelijk: Microsoft Build.<br>Cloud Republic heeft dit evenement op de voet gevolgd en heeft daarbij een selectie gemaakt van de highlights die wij de moeite waard vinden.</p><p></p>
<p></p><p>Gaat u zitten voor grofweg een werkdag aan video’s. Even een avondje geen Netflix maar Channel 9!</p><p></p>
<div style="overflow: auto;"><div style="float: left; width: 50%"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77571?source=%7B%7B%20ctrl.source" target="_blank" rel="noopener"><strong>Vision Keynote - Satya Nadella</strong></a><br>    <img src="/images/msbuild2019/keynote.jpg" style="width: 100%;"><br>    De keynote van Satya moet je natuurlijk gezien hebben. Hij was niet zo technisch als andere jaren maar zeker de moeite waard om te bekijken. In grote lijnen legt Satya uit welke koers Microsoft vaart. Altijd goed om dat scherp te hebben.<br></div><div style="float: left; width: 50%;"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77572?source=%7B%7B%20ctrl.source" target="_blank" rel="noopener"><strong>Microsoft Azure: Empowering Every Developer - Scott Guthrie</strong></a><br>    <img class="nofancybox" src="/images/msbuild2019/azure_keynote.jpg" style="width: 100%;"><br>    Scott Guthrie is de grote baas van Azure. De populariteit van Azure staat als een paal boven water. In deze sessie gaat Scott door een scala van nieuwe features voor Azure en AzureDevops.<br></div></div><br><div style="overflow: auto;"><div style="float: left; width: 50%;"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77031?source=sessions" target="_blank" rel="noopener"><strong>.NET Platform Overview and Roadmap - Scott Hunter and Scott Hanselman</strong></a><br>    <img src="/images/msbuild2019/net_overview.jpg" style="width: 100%;"><br>    .NET is en blijft toch wel het development platform van Microsoft. In deze sessie nemen de “Lesser Scotts” je mee in de nieuwe features van .NET (Core) en geven ze een inkijkje in de toekomst van .NET. (Deze sessie bevat informatie over de aankondiging van .NET 5.0)<br></div><div style="float: left; width: 50%;"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77123?source=sessions" target="_blank" rel="noopener"><strong>All the Developer Things with Hanselman and Friends - Scott Hanselman</strong></a><br>    <img src="/images/msbuild2019/all_the_developer_things.jpg" style="width: 100%;"><br>    Scott Hanselman is naast een uitstekende developer ook een halve komiek. Zijn sessies zijn vaak informatief en hilarisch tegelijk, zo ook deze. Veel kijk plezier!<br></div></div><br><div style="overflow: auto;"><div style="float: left; width: 50%"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77385?source=sessions" target="_blank" rel="noopener"><strong>Look back up C# - Andres Hejlsberg</strong></a><br>    <img src="/images/msbuild2019/look_back.jpg" style="width: 100%;"><br>    Andres Hejlsberg is één van de “Technical Fellows” van Microsoft. Met andere woorden hij is de God Father van C# en TypeScript. Zijn visie op programmeertalen is ongekend, als je iets wilt leren over language design, compilers en dergelijke. Kijk dan zijn sessies.<br></div><div style="float: left; width: 50%;"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77040?source=sessions" target="_blank" rel="noopener"><strong>Whats new in TypeScript - Daniel Rosenwasser</strong></a><br>    <img src="/images/msbuild2019/whats_new_in_typescript.jpg" style="width: 100%;"><br>    Wie schrijft er nog plain JavaScript? Velen zijn al over naar TypeScript, wij ook. Daniel Rosenwasser neemt je mee in de wonderen wereld van TypeScript. Ik durf te wedden dat je 50% van de TypeScript features nog niet gebruikt.<br></div></div><br><div style="overflow: auto;"><div style="float: left; width: 50%"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77336?source=sessions" target="_blank" rel="noopener"><strong>Serverless web apps with Blazor, Azure Functions… - Jeff Hollan</strong></a><br>    <img src="/images/msbuild2019/serverless_webapps.jpg" style="width: 100%;"><br>    Wil je een sessie met veel nieuwe techniek? Kijk dan deze sessie van Jeff Holan. Jeff is de Program Manager van Azure Functions en bouwt in deze sessie een Blazor (C# Web Assembly) applicatie bovenop Azure Functions.<br></div><div style="float: left; width: 50%;"><br>    <a href="https://mybuild.techcommunity.microsoft.com/sessions/77002?source=sessions" target="_blank" rel="noopener"><strong>Inside Azure datacenter architecture - Mark Russinovich</strong></a><br>    <img src="/images/msbuild2019/inside_azure_data_centre.jpg" style="width: 100%;"><br>    Deze sessie moet je gewoon kijken als je ontwikkelt in Azure. Mark Russinovich is de CTO van Azure en hij geeft je in deze sessie een inkijkje in de data centers van Azure.<br></div></div>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/05/09/Microsoft-Build-2019-Must-Watch-Guide/" data-id="cjx635wvq0003bcunqnxue8yl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microsoft-Build/" rel="tag">Microsoft Build</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Proof-of-concept-met-durable-functions" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/28/Proof-of-concept-met-durable-functions/" class="article-date">
  <time datetime="2019-03-28T18:54:37.000Z" itemprop="datePublished">2019-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/28/Proof-of-concept-met-durable-functions/">Proof of concept met durable functions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Case-omschrijving"><a href="#Case-omschrijving" class="headerlink" title="Case omschrijving "></a>Case omschrijving </h2><p>Voor een klant heb ik een Proof of Concept gemaakt om grote hoeveelheden XML bestanden te transformeren het gaat dan 3000 bestanden per keer met een totale grote van 18 gigabyte. Voor dit artikel kan ik wegens privacy niet de echte data gebruiken en heb ik een dataset gebruikt van <a href="https://www.kaggle.com/datasets" target="_blank" rel="noopener">https://www.kaggle.com/datasets</a> het gaat hier om een dataset met landen en de wijnen welke uit het desbetreffende land komen. </p>
<p>Het doel is om de wijnen uit de XML dump te halen en deze om te zetten naar een JSON formaat en deze bestanden te uploaden in een blob container. We krijgen dus per wijn een JSON bestand in een blob container. Dit alles moet gebeuren op basis van durable functions en een constumption plan.</p>
<h2 id="Wat-is-de-opzet-van-de-POC"><a href="#Wat-is-de-opzet-van-de-POC" class="headerlink" title="Wat is de opzet van de POC"></a>Wat is de opzet van de POC</h2><p>Ik ga hier niet heel diep in op wat Durable functions zijn want dat heeft Microsoft heel goed omschreven in hun documentatie <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview</a>.</p>
<p>Ik heb 40 bestanden met landen en wijnen. 1 bestand is ongeveer 75 mb groot. Voor test doeleinde zijn dit dezelfde bestanden met een andere naam. Dit is meer om een gelijkwaardige load op de functie te krijgen als bij de echte POC.</p>
<p>Ik maak in de POC gebruik ik een <em>extract countries</em> activity om de landen uit de XML te halen. Hierna ga met het <em>fan out</em> principe ik per land een activity starten om de wijnen per land uit structuur te halen. Als dit allemaal klaar is wordt er per wijn een activity gestart welke de wijn in JSON formaat upload in een blob container.</p>
<p>Zie hier een overzicht van de durable function:<br><img src="/images/durable-functions-overview.png"></p>
<h2 id="Waar-ben-ik-tegenaan-gelopen-tijdens-de-POC"><a href="#Waar-ben-ik-tegenaan-gelopen-tijdens-de-POC" class="headerlink" title="Waar ben ik tegenaan gelopen tijdens de POC"></a>Waar ben ik tegenaan gelopen tijdens de POC</h2><p>Op papier leek dit de meest perfecte oplossing ik kon de landen in een activity uit de dump halen en dan per land een activity starten om de wijnen op te halen.<br>Dit geeft je een goede schaalbaarheid, als er meer landen in komen worden er meer <em>extract wine</em> activitiy taken aangemaakt.<br>Als er meer wijnen per land komen worden er meerdere <em>upload</em> activity taken aangemaakt.</p>
<p>Per bestand gaat de blob trigger af op de functie. De blob triggers welke niet meteen afgehandeld kunnen worden worden in een queue opgeslagen in het storage account van de function. Deze queue heeft een naam welke begint met <em>azure-webjobs-blobtrigger-</em></p>
<p>Als het bestand binnenkomt wordt er een orchestrator opgestart welke de blobnaam doorgeeft aan de orchestrator.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"WineFunction"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [BlobTrigger(<span class="string">"wine/&#123;name&#125;"</span></span>)]Stream myBlob,</span></span><br><span class="line"><span class="function">    <span class="keyword">string</span> name,</span></span><br><span class="line"><span class="function">    [OrchestrationClient]DurableOrchestrationClient starter,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    log.LogDebug(<span class="string">$"Process file: <span class="subst">&#123;name&#125;</span>"</span>);</span><br><span class="line">    <span class="keyword">await</span> starter.StartNewAsync(<span class="string">"O_Orchestrator"</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>De orchestrator start de activity <em>A_ExtractWineCountries</em> op om de XML op land niveau op te knippen en wacht tot dit klaar is.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"O_Orchestrator"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Orchestrator</span>(<span class="params">[OrchestrationTrigger] DurableOrchestrationContext context, ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fileName = context.GetInput&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="keyword">var</span> wineData = <span class="keyword">await</span> context.CallActivityAsync&lt;Countries[]&gt;(<span class="string">"A_ExtractWineCountries"</span>, fileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Als dit klaar is wordt er per land de activity <em>A_ExtractWines</em> gestart om de wijnen uit de data te halen.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"O_Orchestrator"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Orchestrator</span>(<span class="params">[OrchestrationTrigger] DurableOrchestrationContext context, ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fileName = context.GetInput&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wineCountries = <span class="keyword">await</span> context.CallActivityAsync&lt;Countries[]&gt;(<span class="string">"A_ExtractWineCountries"</span>, fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> tasks = <span class="keyword">new</span> List&lt;Task&lt;Wine[]&gt;&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (Countries wineCountry <span class="keyword">in</span> wineCountries)</span><br><span class="line">    &#123;</span><br><span class="line">        tasks.Add(context.CallActivityAsync&lt;Wine[]&gt;(<span class="string">"A_ExtractWines"</span>, wineCountry));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wineTasks = <span class="keyword">await</span> Task.WhenAll(tasks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Als alle wijn data is opgehaald worden deze parallel geupload in de <em>A_UploadWine</em> activity.  </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"O_Orchestrator"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Orchestrator</span>(<span class="params">[OrchestrationTrigger] DurableOrchestrationContext context, ILogger log</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fileName = context.GetInput&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wineCountries = <span class="keyword">await</span> context.CallActivityAsync&lt;Countries[]&gt;(<span class="string">"A_ExtractWineCountries"</span>, fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> tasks = <span class="keyword">new</span> List&lt;Task&lt;Wine[]&gt;&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (Countries wineCountry <span class="keyword">in</span> wineCountries)</span><br><span class="line">    &#123;</span><br><span class="line">        tasks.Add(context.CallActivityAsync&lt;Wine[]&gt;(<span class="string">"A_ExtractWines"</span>, wineCountry));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wineTasks = <span class="keyword">await</span> Task.WhenAll(tasks);</span><br><span class="line"></span><br><span class="line">    List&lt;Task&gt; uploadWineTasks = <span class="keyword">new</span> List&lt;Task&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (Wine wineTask <span class="keyword">in</span> wineTasks.SelectMany(x =&gt; x))</span><br><span class="line">    &#123;</span><br><span class="line">        uploadWineTasks.Add(context.CallActivityAsync(<span class="string">"A_UploadWine"</span>, wineTask));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> Task.WhenAll(uploadWineTasks);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!context.IsReplaying)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogDebug(<span class="string">$"Finished file: <span class="subst">&#123;fileName&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tot zover ziet het er goed en schaalbaar uit tot ik het publiceerde naar een Azure function app.<br>Ik kopieer met azcopy 40 bestanden van 75 mb in de blob container <em>wine</em> en start application insights op om te zien hoe de applicatie zich gedraagt.<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AzCopy /Source:https://sourceaccount.blob.core.windows.net/source /Dest:https://destaccount.blob.core.windows.net/wine /SourceKey:key1 /DestKey:key2 /S</span><br></pre></td></tr></table></figure></p>
<p>Het resultaat wat ik te zien kreeg maakte me alles behalve blij. De applicatie liep niet soepel en stopte soms geheel met het verwerken van bestanden.<br>Na lang zoeken en fine tunen kwam ik erachter wat een grote oorzaak van het probleem was.</p>
<p>Een Azure function app op een consumption plan heeft een geheugen limiet van 1,5 gigabyte en 1 processor core. Standaard draait Azure durable functions 10X het aantal activities als de host proecessor cores heeft (bij een consumption plan is dit dus 10 activities) en als er toevallig meerdere activities <em>A_ExtractWineCountries</em> worden gestart worden er meerdere XML bestanden in het geheugen geladen a 75 mb. Reken hierbij nog de orchestrator bij en het overige geheugen verbruik van een function app en je zit al snel aan 1,5 gig geheugen.</p>
<p><img src="/images/durable-functions-applicationInsight.png"></p>
<p>Zie het geheugen verbruik van 1 server zit al op 1112MB deze server.</p>
<p>Als je de geheugen limiet hebt bereikt wordt de server gestopt en worden de taken welke op de function app draaide niet afgemaakt deze worden deze opnieuw gestart op een andere function app.  </p>
<p>Je kan instellen hoeveel activities en orchestrators er op een function app gestart mogen worden. Dit kun je doen in de host.config (<a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-bindings#hostjson-settings)" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-bindings#hostjson-settings)</a>. Je kan de waardes aanpassen naar een lagere waarde alleen loopt het proces niet lekker stabiel door. Doordat het niet lekker stabiel doorloopt en dit als gevolg heeft dat de cpu belasting op en neer gaat gaat het automatisch schalen niet soepel.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extensions"</span>: &#123;</span><br><span class="line">    <span class="attr">"durableTask"</span>: &#123;</span><br><span class="line">      <span class="attr">"maxConcurrentActivityFunctions"</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">"maxConcurrentOrchestratorFunctions"</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Demoproject"><a href="#Demoproject" class="headerlink" title="Demoproject"></a>Demoproject</h2><p>Ik heb een demo project gemaakt welke een volledig werkende solution bevat.<br>Zie hieronder de stappen om het durable functions project te starten:</p>
<ul>
<li>Clone de repository <a href="https://github.com/marcoippel/durablefunctionsdemo" target="_blank" rel="noopener">https://github.com/marcoippel/durablefunctionsdemo</a></li>
<li>Maak een storage account aan in Azure</li>
<li>Maak een functions app aan in Azure en configureer de connectionstring in de appsettings </li>
<li>Maak in de blob storage een 3 tal blob containers aan genaamd:<ul>
<li>source</li>
<li>wines</li>
<li>wine</li>
</ul>
</li>
<li>Publiseer het project naar de functions app.</li>
<li>Maak van het bestand DurableFunctionDemo/winedata.xml 40 kopieën en upload deze naar de wine folder in Azure storage</li>
</ul>
<p>Start applications insight en kijk hoe de applicatie zich gedraagt.</p>
<h2 id="Conclusie"><a href="#Conclusie" class="headerlink" title="Conclusie"></a>Conclusie</h2><p>Durable functions op een consumption plan is een hele mooie oplossing maar niet voor een applicatie welke intensief geheugen gebruikt en snel veel bestanden moet verwerken. Je blijft met het geheugen limiet van 1,5 gigabyte en je hebt geen invloed op welke activities er op een functions app worden gehost. </p>
<p><img src="/images/durable-functions-storage.png"></p>
<p>Er zit best wel wat overhead in het proces hij gebruikt namelijk je Azure storage account als queue voor communicatie tussen de orchestrator en de activities. Als je bericht groter is dan in de queue pas plaatst hij het in een blob container. Bijvoorbeeld als de berichten welke naar de activity <em>A_UploadWine</em> gaan groter zijn als 64KB (<a href="https://docs.microsoft.com/nl-nl/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted#capacity-and-quotas" target="_blank" rel="noopener">https://docs.microsoft.com/nl-nl/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted#capacity-and-quotas</a>) dan zullen deze in een blob container <em>durablefunctionshub-largemessages</em> worden opgeslagen om vervolgens op gehaald te worden in de activity <em>A_UploadWine</em> en deze activity upload hem dan naar de uiteindelijke blob container. Hier zitten al 2 blob storage acties in welke ook tijd en resources kosten.</p>
<p>Deze POC heeft het doel niet behaald wat we voor ogen hadden en we zullen opzoek gaan naar een andere oplossing. Het idee is om de taken te verdelen over meerdere Azure function apps. Zodra die POC is uitgewerkt zal ik de bevindingen delen in een nieuwe blog.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/03/28/Proof-of-concept-met-durable-functions/" data-id="cjw0ftevl00043ounfgb7lhwd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Migrating-AngularJS-to-Angular-Going-Hybrid" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/11/Migrating-AngularJS-to-Angular-Going-Hybrid/" class="article-date">
  <time datetime="2019-01-11T13:28:20.000Z" itemprop="datePublished">2019-01-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/11/Migrating-AngularJS-to-Angular-Going-Hybrid/">Migrating AngularJS to Angular - Going Hybrid</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So, you are finally ready to start to migrate your old AngularJS to the new fancy Angular 7. But it is kind of big and you cannot afford not to release for half a year. So how are you going to do it? You want to upgrade to the latest Angular version, but you can’t do it with a big bang. Well there is a great hybrid solution made by the Angular team called @Angular/Upgrade. It basically lets you run AngularJS inside Angular and makes all you’re AngularJS Services, Components, Directives etc. available in Angular and vice versa.     </p>
<h2 id="Getting-your-AngularJS-Code-ready"><a href="#Getting-your-AngularJS-Code-ready" class="headerlink" title="Getting your AngularJS Code ready"></a>Getting your AngularJS Code ready</h2><p>First, we need to get our source code and build process ready. Secondly, we need to switch to webpack, this will make the rest of the steps way easier. Because every application has different needs I won’t go into detail on how to do this. But for those of you who’ve never used Webpack before, <a href="https://webpack.js.org/guides/getting-started/" target="_blank" rel="noopener">this quickstart</a> will give you a head start.</p>
<p>If you haven’t done so already install all your dependencies with a package manager like NPM, this will save you a lot of headaches while merging AngularJS with Angular.</p>
<p>The last step is to migrate all JavaScript files to typescript. Although recommended it is only required if you are planning to migrate your existing AngularJS code to Angular.</p>
<p><code>rename *.js *.ts</code></p>
<p>Should do the trick on windows.<br>To use TypeScript, you need to add TSConfig file, a basic example is found below.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"noImplicitAny"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noEmitOnError"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"removeComments"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"sourceMap"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"es5"</span>,</span><br><span class="line">    <span class="attr">"module"</span>: <span class="string">"es2015"</span>,</span><br><span class="line">    <span class="attr">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">    <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noStrictGenericChecks"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"lib"</span>: [<span class="string">"es2018"</span>, <span class="string">"dom"</span>],</span><br><span class="line">    <span class="attr">"suppressImplicitAnyIndexErrors"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"rootDir"</span>: <span class="string">"src"</span>,</span><br><span class="line">    <span class="attr">"outDir"</span>: <span class="string">"dist"</span>,</span><br><span class="line">    <span class="attr">"baseUrl"</span>: <span class="string">"./"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Optionally you could add type definitions for AngularJS and other dependencies this will add type hint’s for your old AngularJS code.</p>
<h2 id="Installing-Angular"><a href="#Installing-Angular" class="headerlink" title="Installing Angular"></a>Installing Angular</h2><p>So the first step is to installing the Angular Framework. Just run the following NPM command and your good.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i –save @angular/common @angular/compiler @angular/core @angular/forms @angular/http @angular/platform-browser @angular/platform-browser-dynamic core-js zone.js</span><br></pre></td></tr></table></figure>
<p>We need to add one more dependency. This package will handle the communication between AngularJS and Angular.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i –save @angular/upgrade</span><br></pre></td></tr></table></figure>
<h2 id="Setting-up-the-hybrid"><a href="#Setting-up-the-hybrid" class="headerlink" title="Setting up the hybrid"></a>Setting up the hybrid</h2><p>Now that we have everything installed we can start coding. First add an file called app.module.ts to your source root. This will be our root angular module and will bootstrap AngularJS.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">"@angular/core"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UpgradeModule &#125; <span class="keyword">from</span> <span class="string">"@angular/upgrade/static"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  imports: [BrowserModule, UpgradeModule],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> upgrade: UpgradeModule</span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> ngDoBootstrap() &#123;</span><br><span class="line">    <span class="comment">// bootstrap(angularJs root element in dom, AngularJS root module, bootstrap options)</span></span><br><span class="line">    <span class="keyword">this</span>.upgrade.bootstrap(<span class="built_in">document</span>.body, [<span class="string">"app"</span>], &#123; strictDi: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Angular doesn’t magically know that this is the root module. The code to tell Angular this is usually placed in a file called main.ts, this file needs to be added as an entry in the webpack configuration.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"./app"</span>; <span class="comment">// AngularJS code</span></span><br><span class="line"><span class="keyword">import</span> &#123; platformBrowserDynamic &#125; <span class="keyword">from</span> <span class="string">"@angular/platform-browser-dynamic"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppModule &#125; <span class="keyword">from</span> <span class="string">"./app.module"</span>;</span><br><span class="line"></span><br><span class="line">platformBrowserDynamic().bootstrapModule(AppModule);</span><br></pre></td></tr></table></figure>
<p>Finally, we need to add some Polyfills. Usually this is added in a separate file and added to the webpack config as an entry. So, let’s add a polyfills.ts<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"core-js/es6/reflect"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"core-js/es7/reflect"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"zone.js/dist/zone"</span>;</span><br></pre></td></tr></table></figure></p>
<p>That’s it. You are running in hybrid.</p>
<h2 id="So-what’s-next"><a href="#So-what’s-next" class="headerlink" title="So, what’s next"></a>So, what’s next</h2><p>There is not one way to upgrade your project. If you’re planning to migrate your existing AngularJS components to Angular you should take a look at upgrading AngularJS components to work with Angular <a href="https://angular.io/api/upgrade/static/UpgradeComponent" target="_blank" rel="noopener">over here</a> and Downgrading Angular Components to work with AngularJS <a href="https://angular.io/api/upgrade/static/downgradeComponent" target="_blank" rel="noopener">over here</a>. These will allow you to keep upgrade a component without breaking the stuff around it.<br>But if you are on an older code base that uses separate controllers and html templates, you should rewrite your code to a component-based system. A tool that could help you is the hybrid library for UI-Router. This will allow you to upgrade page by page. You can find this library <a href="https://github.com/ui-router/angular-hybrid" target="_blank" rel="noopener">over here</a>.</p>
<p><strong> This blog is written by: </strong><br>Martin Ligtenberg</p>
<script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="IN/MemberProfile" data-id="https://www.linkedin.com/in/mvligtenberg/" data-format="inline" data-related="false"></script>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2019/01/11/Migrating-AngularJS-to-Angular-Going-Hybrid/" data-id="cjw0ftevk00033ounzwfblanr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AngularJS/" rel="tag">AngularJS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hybrid/" rel="tag">Hybrid</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Cloud-Republic-investeert-in-medewerkers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/01/Cloud-Republic-investeert-in-medewerkers/" class="article-date">
  <time datetime="2018-06-01T12:28:20.000Z" itemprop="datePublished">2018-06-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/01/Cloud-Republic-investeert-in-medewerkers/">Cloud Republic investeert in medewerkers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Bij Cloud Republic werken developers die steen goed zijn in het bouwen van maatwerkapplciaties in de Cloud.<br>Wij geloven dat synergie in een team belangrijk is. Wij streven naar een team met soortgelijke skills die elkaar weten te versterken.<br>Om te toetsen of nieuwe medewerkers passen en om huidige medewerkers een duidelijke groei richting te geven hebben we een baseline opgesteld.</p>
<p>Deze baseline is een set van skills en competenties die je “zou moeten” beheersen. Ik zeg met klem “zou moeten” want we weten dat de perfecte developer niet bestaat.<br>Wij vinden het belangrijker dat je een duidelijke groei richting hebt, dan dat je alle competenties al beheerst.</p>
<p><img src="/images/baseline.png"></p>
<p>Wij geloven dat je de basis kennis van Front-end, Back-end, Cloud en DevOps moet hebben om effectief maatwerkapplicaties in de Cloud te bouwen. Dit betekent niet dat je je niet kan specialiseren, we moedigen specialisme’s in één van de competenties ook aan!</p>
<h2 id="Investering"><a href="#Investering" class="headerlink" title="Investering"></a>Investering</h2><p>Microsoft is onlangs gestart met de uitrol van <a href="https://www.microsoft.com/en-us/learning/browse-new-certification.aspx" target="_blank" rel="noopener">Role-based certificeringen</a>. 2 van deze certificeringstrajecten zijn ons op het lijf geschreven, namelijk:</p>
<p><div><div style="width: 50%; float:left;"><img src="/images/azure-developer.png" width="200"></div><div style="width: 50%; float: left;"><img src="/images/azure-solutions-architect.png" width="200"></div></div><br><br><br>Wij moedigen onze medewerkers aan om deze certificeringen te halen. Een traject bestaat uit 2 examens of 1 examen als je een vergelijkbaar ouder traject hebt afgerond.<br>De kosten zijn 160 dollar per examen, hier doen we bij Cloud Republic niet moeilijk over. Sterker nog je krijgt een bonus als je het examen in 1x haalt.</p>
<p>We willen medewerkers motiveren om aantoonbare kennis van Azure op te doen en daar doen we dan ook alles voor.<br>Medewerkers krijgen naast een vergoeding voor de examens ook tijd om te studeren, zodat je niet alles thuis in de avonduurtjes hoeft te doen. Sterker nog, als er genoeg animo is huren we soms zelfs een trainer in om de medewerkers in een sneltrein vaart klaar te stomen voor de examens.</p>
<p><img src="/images/formule.png"></p>
<p>Meer weten over Cloud Republic? Bezoek: <a href="https://cloudrepublic.nl" target="_blank" rel="noopener">https://cloudrepublic.nl</a> of neem contact op met <a href="https://twitter.com/DibranMulder" target="_blank" rel="noopener">@DibranMulder</a> op Twitter of op <a href="https://www.linkedin.com/in/dibranmulder/" target="_blank" rel="noopener">LinkedIn</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2018/06/01/Cloud-Republic-investeert-in-medewerkers/" data-id="cjw0ftev900003oune0srmvzo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Certificering/" rel="tag">Certificering</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cloud-Republic/" rel="tag">Cloud Republic</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/01/hello-world/" class="article-date">
  <time datetime="2018-04-01T12:28:20.000Z" itemprop="datePublished">2018-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/01/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to our blog, Cloud Republic will post here about: Cloud Development<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Hello World! program in C#.</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">HelloWorld</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Hello</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">"Hello World!"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Keep the console window open in debug mode.</span></span><br><span class="line">            Console.WriteLine(<span class="string">"Press any key to exit."</span>);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cloudrepublic.github.io/2018/04/01/hello-world/" data-id="cjw0ftevp00073ounomxvc8nx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AngularJS/" rel="tag">AngularJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-DevOps/" rel="tag">Azure DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Certificering/" rel="tag">Certificering</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Republic/" rel="tag">Cloud Republic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuous-Deployment/" rel="tag">Continuous Deployment</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuous-Integration/" rel="tag">Continuous Integration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker-swarm/" rel="tag">Docker swarm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Frontend/" rel="tag">Frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gulp/" rel="tag">Gulp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hybrid/" rel="tag">Hybrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Let-s-Encrypt/" rel="tag">Let's Encrypt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microsoft-Build/" rel="tag">Microsoft Build</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Office-365/" rel="tag">Office 365</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Portainer/" rel="tag">Portainer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Release-pipeline/" rel="tag">Release pipeline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Release-schedule/" rel="tag">Release schedule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPFx/" rel="tag">SPFx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SharePoint-Framework/" rel="tag">SharePoint Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SharePoint-Online/" rel="tag">SharePoint Online</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Traefik/" rel="tag">Traefik</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpart/" rel="tag">Webpart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Workbench/" rel="tag">Workbench</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Angular/" style="font-size: 10px;">Angular</a> <a href="/tags/AngularJS/" style="font-size: 10px;">AngularJS</a> <a href="/tags/Azure/" style="font-size: 10px;">Azure</a> <a href="/tags/Azure-DevOps/" style="font-size: 10px;">Azure DevOps</a> <a href="/tags/Certificering/" style="font-size: 10px;">Certificering</a> <a href="/tags/Cloud-Republic/" style="font-size: 10px;">Cloud Republic</a> <a href="/tags/Continuous-Deployment/" style="font-size: 10px;">Continuous Deployment</a> <a href="/tags/Continuous-Integration/" style="font-size: 10px;">Continuous Integration</a> <a href="/tags/Docker-swarm/" style="font-size: 10px;">Docker swarm</a> <a href="/tags/Frontend/" style="font-size: 20px;">Frontend</a> <a href="/tags/Gulp/" style="font-size: 10px;">Gulp</a> <a href="/tags/Hybrid/" style="font-size: 10px;">Hybrid</a> <a href="/tags/Let-s-Encrypt/" style="font-size: 10px;">Let's Encrypt</a> <a href="/tags/Microsoft-Build/" style="font-size: 10px;">Microsoft Build</a> <a href="/tags/Office-365/" style="font-size: 20px;">Office 365</a> <a href="/tags/Portainer/" style="font-size: 10px;">Portainer</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Release-pipeline/" style="font-size: 10px;">Release pipeline</a> <a href="/tags/Release-schedule/" style="font-size: 10px;">Release schedule</a> <a href="/tags/SPFx/" style="font-size: 20px;">SPFx</a> <a href="/tags/SharePoint-Framework/" style="font-size: 20px;">SharePoint Framework</a> <a href="/tags/SharePoint-Online/" style="font-size: 20px;">SharePoint Online</a> <a href="/tags/Traefik/" style="font-size: 10px;">Traefik</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Webpart/" style="font-size: 20px;">Webpart</a> <a href="/tags/Workbench/" style="font-size: 10px;">Workbench</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/03/Docker-Swarm/">Docker Swarm, Traefik, Let&#39;s Encrypt en Portainer</a>
          </li>
        
          <li>
            <a href="/2019/10/17/CICD-SharePointFramework-part-1/">Continuous Integration &amp; Deployment with SharePoint Framework Solutions - Part 1 of 2</a>
          </li>
        
          <li>
            <a href="/2019/06/27/Proof-of-concept-met-azure-batch/">Proof of concept met Azure Batch</a>
          </li>
        
          <li>
            <a href="/2019/06/14/Getting-started-with-SPfx/">Getting started with SharePoint Framework</a>
          </li>
        
          <li>
            <a href="/2019/05/22/follow-the-moon/">Following the moon</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Cloud Republic<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>